<template>
  <v-card class="trend-chart-card" elevation="3">
    <v-card-title class="text-h6 font-weight-bold pa-4 pb-2 d-flex align-center">
      <v-icon class="mr-2" color="primary">mdi-trending-up</v-icon>
      Vulnerability Trends (Last 30 Days)
    </v-card-title>
    <v-card-text class="pa-4 pt-0">
      <div v-if="!data || data.length === 0" class="text-center pa-8">
        <div class="empty-state">
          <v-icon size="64" color="grey" class="mb-4">mdi-chart-line</v-icon>
          <h3 class="text-h6 font-weight-bold mb-2">No Trend Data</h3>
          <p class="text-body-2 text-medium-emphasis">No vulnerabilities detected in the last 30 days</p>
          <v-chip color="success" variant="tonal" class="mt-4">
            <v-icon start>mdi-check-circle</v-icon>
            Good Security Posture
          </v-chip>
        </div>
      </div>
      <div v-else class="trend-container">
        <!-- Trend Summary -->
        <div class="trend-summary mb-4">
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Total in Period</div>
              <div class="summary-value">{{ totalVulnerabilities }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Average Daily</div>
              <div class="summary-value">{{ averageDaily }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Peak Day</div>
              <div class="summary-value">{{ peakDay }}</div>
            </div>
          </div>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
          <Line :data="chartData" :options="chartOptions" />
        </div>
        
        <!-- Trend Analysis -->
        <div class="trend-analysis mt-4">
          <v-chip
            :color="trendColor"
            variant="tonal"
            size="small"
            class="mr-2"
          >
            <v-icon start>{{ trendIcon }}</v-icon>
            {{ trendDescription }}
          </v-chip>
        </div>
      </div>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { Line } from 'vue-chartjs'
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend
} from 'chart.js'

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend
)

interface TrendData {
  created_at__date: string
  count: number
}

interface Props {
  data: TrendData[]
}

const props = defineProps<Props>()

const totalVulnerabilities = computed(() => {
  return props.data?.reduce((sum, item) => sum + item.count, 0) || 0
})

const averageDaily = computed(() => {
  if (!props.data || props.data.length === 0) return 0
  return Math.round(totalVulnerabilities.value / props.data.length)
})

const peakDay = computed(() => {
  if (!props.data || props.data.length === 0) return 0
  return Math.max(...props.data.map(item => item.count))
})

const trendColor = computed(() => {
  if (totalVulnerabilities.value === 0) return 'success'
  if (averageDaily.value > 10) return 'error'
  if (averageDaily.value > 5) return 'warning'
  return 'info'
})

const trendIcon = computed(() => {
  if (totalVulnerabilities.value === 0) return 'mdi-check-circle'
  if (averageDaily.value > 10) return 'mdi-trending-up'
  if (averageDaily.value > 5) return 'mdi-alert'
  return 'mdi-information'
})

const trendDescription = computed(() => {
  if (totalVulnerabilities.value === 0) return 'No vulnerabilities detected'
  if (averageDaily.value > 10) return 'High vulnerability rate'
  if (averageDaily.value > 5) return 'Moderate vulnerability rate'
  return 'Low vulnerability rate'
})

const chartData = computed(() => ({
  labels: props.data?.map(item => {
    const date = new Date(item.created_at__date)
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  }) || [],
  datasets: [{
    label: 'Vulnerabilities',
    data: props.data?.map(item => item.count) || [],
    borderColor: '#1976d2',
    backgroundColor: 'rgba(25, 118, 210, 0.1)',
    borderWidth: 3,
    fill: true,
    tension: 0.4,
    pointBackgroundColor: '#1976d2',
    pointBorderColor: '#ffffff',
    pointBorderWidth: 2,
    pointRadius: 6,
    pointHoverRadius: 8
  }]
}))

const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      display: false
    },
    tooltip: {
      backgroundColor: 'rgba(0, 0, 0, 0.8)',
      titleColor: '#ffffff',
      bodyColor: '#ffffff',
      borderColor: '#1976d2',
      borderWidth: 1,
      cornerRadius: 8,
      displayColors: false
    }
  },
  scales: {
    x: {
      grid: {
        display: false
      },
      ticks: {
        color: '#666666',
        font: {
          size: 12
        }
      }
    },
    y: {
      beginAtZero: true,
      grid: {
        color: '#e0e0e0'
      },
      ticks: {
        color: '#666666',
        font: {
          size: 12
        }
      }
    }
  }
}
</script>

<style scoped>
.trend-chart-card {
  border-radius: 16px;
  height: 100%;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.empty-state {
  padding: 32px;
  text-align: center;
}

.trend-container {
  padding: 8px;
}

.trend-summary {
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  padding: 16px;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 16px;
}

.summary-item {
  text-align: center;
  padding: 12px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.6);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.summary-label {
  font-size: 0.75rem;
  color: #666666;
  font-weight: 500;
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #2c3e50;
}

.chart-container {
  height: 250px;
  position: relative;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  padding: 16px;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.trend-analysis {
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

/* Matrix theme override */
.v-theme--matrix .trend-chart-card {
  background: #000 !important;
  border: 1px solid #39FF14 !important;
}

.v-theme--matrix .trend-chart-card .v-card-title {
  color: #39FF14 !important;
}

.v-theme--matrix .trend-chart-card .summary-value {
  color: #39FF14 !important;
}

.v-theme--matrix .trend-chart-card .summary-label {
  color: #39FF14 !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .summary-grid {
    grid-template-columns: 1fr;
  }
}
</style> 