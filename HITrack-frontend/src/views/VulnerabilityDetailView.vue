<template>
  <v-container fluid class="pa-6">
    <v-row v-if="loading">
      <v-col cols="12" class="text-center">
        <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
        <div class="mt-4 text-h6">Loading vulnerability details...</div>
      </v-col>
    </v-row>
    
    <v-row v-else-if="!vulnerability">
      <v-col cols="12" class="text-center">
        <v-icon size="64" color="error" class="mb-4">mdi-alert-circle</v-icon>
        <div class="text-h6 mb-2">Vulnerability not found</div>
        <div class="text-body-2 text-grey">The requested vulnerability could not be loaded.</div>
      </v-col>
    </v-row>
    
    <v-row v-else>
      <v-col cols="12">
        <!-- Header -->
        <div class="d-flex justify-space-between align-center mb-6">
          <div>
            <h1 class="text-h3 font-weight-bold mb-2">{{ vulnerability?.vulnerability_id }}</h1>
            <div class="d-flex align-center">
              <v-chip :color="getSeverityColor(vulnerability?.severity)" size="large" class="mr-3">
                {{ vulnerability?.severity }}
              </v-chip>
              <v-chip v-if="vulnerability?.details?.cisa_kev_known_exploited" color="error" size="small">
                <v-icon class="mr-1">mdi-shield-alert</v-icon>
                CISA KEV
              </v-chip>
              <v-chip v-if="vulnerability?.details?.exploit_available" color="error" size="small" class="ml-2">
                <v-icon class="mr-1">mdi-bug</v-icon>
                Exploit Available
              </v-chip>
            </div>
          </div>
        </div>

        <!-- Unified Security Metrics Card -->
        <v-card class="mb-6" elevation="3">
          <v-card-title class="text-h5 pa-6 pb-4">
            <v-icon class="mr-3" color="primary">mdi-shield-alert</v-icon>
            Security Metrics
          </v-card-title>
          <v-card-text class="pa-6 pt-0">
            <v-row>
              <!-- CVSS Score Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" :color="vulnerability?.details?.cve_details_score ? getCvssColor(vulnerability.details.cve_details_score) : 'grey'" class="mr-3">
                      mdi-chart-box
                    </v-icon>
                    <div>
                      <div class="text-h4 font-weight-black" :class="vulnerability?.details?.cve_details_score ? getCvssTextColor(vulnerability.details.cve_details_score) : ''">
                        {{ vulnerability?.details?.cve_details_score || 'N/A' }}
                      </div>
                      <div class="text-caption text-grey">CVSS Score</div>
                    </div>
                  </div>
                  <v-progress-linear
                    v-if="vulnerability?.details?.cve_details_score"
                    :model-value="(vulnerability.details.cve_details_score / 10) * 100"
                    :color="getCvssColor(vulnerability.details.cve_details_score)"
                    height="8"
                    rounded
                  ></v-progress-linear>
                </div>
              </v-col>

              <!-- EPSS Score Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" color="info" class="mr-3">mdi-chart-line</v-icon>
                    <div>
                      <div class="text-h4 font-weight-black">
                        {{ vulnerability?.epss ? (vulnerability.epss * 100).toFixed(1) + '%' : 'N/A' }}
                      </div>
                      <div class="text-caption text-grey">EPSS Score</div>
                    </div>
                  </div>
                  <v-progress-linear
                    v-if="vulnerability?.epss"
                    :model-value="vulnerability.epss * 100"
                    color="info"
                    height="8"
                    rounded
                  ></v-progress-linear>
                </div>
              </v-col>

              <!-- CISA KEV Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" class="mr-3">
                      {{ vulnerability?.details?.cisa_kev_known_exploited ? 'mdi-shield-alert' : 'mdi-shield-check' }}
                    </v-icon>
                    <div>
                      <div class="text-h4 font-weight-black" :class="vulnerability?.details?.cisa_kev_known_exploited ? 'text-error' : 'text-success'">
                        {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Yes' : 'No' }}
                      </div>
                      <div class="text-caption text-grey">CISA KEV</div>
                    </div>
                  </div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" size="small" variant="outlined">
                    {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Known Exploited' : 'Not in KEV' }}
                  </v-chip>
                </div>
              </v-col>

              <!-- Exploit Available Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" class="mr-3">
                      {{ vulnerability?.details?.exploit_available ? 'mdi-bug' : 'mdi-shield-check' }}
                    </v-icon>
                    <div>
                      <div class="text-h4 font-weight-black" :class="vulnerability?.details?.exploit_available ? 'text-error' : 'text-success'">
                        {{ vulnerability?.details?.exploit_available ? 'Yes' : 'No' }}
                      </div>
                      <div class="text-caption text-grey">Exploit Available</div>
                    </div>
                  </div>
                  <v-chip :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" size="small" variant="outlined">
                    {{ vulnerability?.details?.exploit_available ? 'Available' : 'Not Available' }}
                  </v-chip>
                </div>
              </v-col>
            </v-row>

            <!-- Security Status Bar -->
            <v-divider class="my-4"></v-divider>
            <div class="d-flex justify-space-between align-center">
              <div class="text-subtitle-2 text-grey">Overall Security Status:</div>
              <div class="d-flex align-center">
                <v-chip 
                  :color="getOverallSecurityColor()" 
                  size="small" 
                  class="mr-2"
                >
                  {{ getOverallSecurityStatus() }}
                </v-chip>
                <v-icon :color="getOverallSecurityColor()" size="20">
                  {{ getOverallSecurityIcon() }}
                </v-icon>
              </div>
            </div>
          </v-card-text>
        </v-card>

        <!-- Main Content -->
        <v-row>
          <!-- Left Column -->
          <v-col cols="12" lg="8">
            <!-- Description Section -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-text</v-icon>
                Description
              </v-card-title>
              <v-card-text>
                <div v-if="vulnerability?.details?.cisa_kev_short_description" class="mb-4">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">CISA KEV Description</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_short_description }}</div>
                </div>
                <div v-if="vulnerability?.details?.cve_details_summary" class="mb-4">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">CVE Details Summary</div>
                  <div class="text-body-1">{{ vulnerability.details.cve_details_summary }}</div>
                </div>
                <div v-if="vulnerability?.description">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">System Description</div>
                  <div class="text-body-1">{{ vulnerability.description }}</div>
                </div>
                <div v-if="!vulnerability?.details?.cisa_kev_short_description && !vulnerability?.details?.cve_details_summary && !vulnerability?.description" class="text-center py-8">
                  <v-icon size="64" color="grey" class="mb-4">mdi-text-off</v-icon>
                  <div class="text-h6 text-grey">No description available</div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CISA KEV Information -->
            <v-card v-if="vulnerability?.details?.cisa_kev_known_exploited" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="error">mdi-shield-alert</v-icon>
                CISA KEV Information
              </v-card-title>
              <v-card-text>
                <v-row>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Vendor/Project</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_vendor_project || 'N/A' }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Product</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_product || 'N/A' }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Vulnerability Name</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_vulnerability_name || 'N/A' }}</div>
                    </div>
                  </v-col>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Date Added</div>
                      <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability.details.cisa_kev_date_added) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Due Date</div>
                      <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability.details.cisa_kev_due_date) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Ransomware Use</div>
                      <v-chip :color="vulnerability.details.cisa_kev_ransomware_use === 'Known' ? 'error' : 'success'" size="small">
                        {{ vulnerability.details.cisa_kev_ransomware_use || 'Unknown' }}
                      </v-chip>
                    </div>
                  </v-col>
                </v-row>
                <div v-if="vulnerability.details.cisa_kev_required_action" class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Required Action</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_required_action }}</div>
                </div>
                <div v-if="vulnerability.details.cisa_kev_notes" class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Notes</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_notes }}</div>
                </div>
                <div v-if="vulnerability.details.cisa_kev_cwes?.length">
                  <div class="text-subtitle-2 text-grey mb-1">CWEs</div>
                  <div class="d-flex flex-wrap">
                    <v-chip v-for="cwe in vulnerability.details.cisa_kev_cwes" :key="cwe" size="small" class="mr-2 mb-2" color="warning">
                      {{ cwe }}
                    </v-chip>
                  </div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CVE Details -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-chart-timeline-variant</v-icon>
                CVE Details
              </v-card-title>
              <v-card-text>
                <v-row>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">CVSS Score</div>
                      <div class="d-flex align-center">
                        <v-chip v-if="vulnerability?.details?.cve_details_score" :color="getCvssColor(vulnerability.details.cve_details_score)" size="small" class="mr-2">
                          {{ vulnerability.details.cve_details_score }}
                        </v-chip>
                        <span v-else class="text-grey">N/A</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Severity</div>
                      <v-chip v-if="vulnerability?.details?.cve_details_severity" :color="getSeverityColor(vulnerability.details.cve_details_severity)" size="small">
                        {{ vulnerability.details.cve_details_severity }}
                      </v-chip>
                      <span v-else class="text-grey">N/A</span>
                    </div>
                  </v-col>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Published</div>
                      <div class="text-body-1">{{ formatDate(vulnerability?.details?.cve_details_published_date) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Updated</div>
                      <div class="text-body-1">{{ formatDate(vulnerability?.details?.cve_details_updated_date) }}</div>
                    </div>
                  </v-col>
                </v-row>
                <div v-if="vulnerability?.details?.cve_details_references?.length">
                  <div class="d-flex align-center justify-space-between mb-2">
                    <div class="text-subtitle-2 text-grey">References</div>
                    <v-btn 
                      variant="text" 
                      size="small" 
                      @click="showReferences = !showReferences"
                      class="text-caption"
                    >
                      <v-icon size="16" class="mr-1">
                        {{ showReferences ? 'mdi-chevron-up' : 'mdi-chevron-down' }}
                      </v-icon>
                      {{ showReferences ? 'Hide' : 'Show' }} ({{ vulnerability.details.cve_details_references.length }})
                    </v-btn>
                  </div>
                  <v-expand-transition>
                    <div v-if="showReferences" class="d-flex flex-column">
                      <a v-for="(ref, index) in vulnerability.details.cve_details_references" :key="index" 
                         :href="ref" target="_blank" class="text-body-2 text-primary mb-1">
                        {{ ref }}
                      </a>
                    </div>
                  </v-expand-transition>
                </div>
              </v-card-text>
            </v-card>

            <!-- Exploit Information -->
            <v-card v-if="vulnerability?.details?.exploit_available" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="error">mdi-bug</v-icon>
                Exploit Information
              </v-card-title>
              <v-card-text>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Status</div>
                  <div class="d-flex align-center">
                    <v-chip color="error" size="small" class="mr-2">
                      <v-icon class="mr-1">mdi-bug</v-icon>
                      Available
                    </v-chip>
                    <v-chip v-if="vulnerability.details.exploit_public" color="warning" size="small" class="mr-2">
                      Public
                    </v-chip>
                    <v-chip v-if="vulnerability.details.exploit_verified" color="success" size="small">
                      Verified
                    </v-chip>
                  </div>
                </div>
                <div v-if="vulnerability?.details?.exploit_links?.length">
                  <div class="text-subtitle-2 text-grey mb-2">Exploit Links</div>
                  <div class="d-flex flex-column">
                    <a v-for="(link, index) in vulnerability.details.exploit_links" :key="index" 
                       :href="link" target="_blank" class="text-body-2 text-primary mb-1">
                      {{ link }}
                    </a>
                  </div>
                </div>
              </v-card-text>
            </v-card>
          </v-col>

          <!-- Right Column -->
          <v-col cols="12" lg="4">
            <!-- Quick Info -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-information</v-icon>
                Quick Info
              </v-card-title>
              <v-card-text>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Vulnerability Type</div>
                  <div class="text-body-1 font-weight-medium">{{ vulnerability?.vulnerability_type }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Created</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.created_at) }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Last Updated</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.updated_at) }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Data Source</div>
                  <div class="text-body-1 font-weight-medium">{{ vulnerability?.details?.data_source || 'N/A' }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Details Updated</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.details?.last_updated) }}</div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CVSS Score Card -->
            <v-card v-if="vulnerability?.details?.cve_details_score" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-chart-box</v-icon>
                CVSS Score
              </v-card-title>
              <v-card-text>
                <div class="text-center">
                  <div class="text-h2 font-weight-black mb-2" :class="getCvssTextColor(vulnerability.details.cve_details_score)">
                    {{ vulnerability.details.cve_details_score }}
                  </div>
                  <v-chip :color="getCvssColor(vulnerability.details.cve_details_score)" size="large">
                    {{ vulnerability.details.cve_details_severity }}
                  </v-chip>
                </div>
              </v-card-text>
            </v-card>

            <!-- Security Status -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-shield-check</v-icon>
                Security Status
              </v-card-title>
              <v-card-text>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">CISA KEV</div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Known Exploited' : 'Not in KEV' }}
                  </v-chip>
                </div>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Exploit Available</div>
                  <v-chip :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.exploit_available ? 'Available' : 'Not Available' }}
                  </v-chip>
                </div>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Ransomware Use</div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_ransomware_use === 'Known' ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.cisa_kev_ransomware_use || 'Unknown' }}
                  </v-chip>
                </div>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import type { Vulnerability } from '@/types/interfaces'

const route = useRoute()
const vulnerability = ref<Vulnerability | null>(null)
const loading = ref(true)
const showReferences = ref(false)

onMounted(async () => {
  try {
    const vulnerabilityId = route.params.uuid
    if (!vulnerabilityId) {
      console.error('No vulnerability UUID provided')
      return
    }
    
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerabilityId}/`, {
      headers
    })
    
    if (response.ok) {
      vulnerability.value = await response.json()
    } else {
      console.error('Failed to fetch vulnerability:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error fetching vulnerability:', error)
  } finally {
    loading.value = false
  }
})

const getCvssColor = (score: number): string => {
  if (score >= 9.0) return 'error'
  if (score >= 7.0) return 'warning'
  if (score >= 4.0) return 'info'
  return 'success'
}

const getCvssTextColor = (score: number): string => {
  if (score >= 9.0) return 'text-error'
  if (score >= 7.0) return 'text-warning'
  if (score >= 4.0) return 'text-info'
  return 'text-success'
}

const getSeverityColor = (severity?: string): string => {
  if (!severity) return 'grey'
  switch (severity.toUpperCase()) {
    case 'CRITICAL': return 'error'
    case 'HIGH': return 'warning'
    case 'MEDIUM': return 'info'
    case 'LOW': return 'success'
    default: return 'grey'
  }
}

const formatDate = (dateString: string | null | undefined): string => {
  if (!dateString) return 'N/A'
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

const getOverallSecurityColor = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'error'
  if (cvssScore >= 7.0) return 'warning'
  if (cvssScore >= 4.0) return 'info'
  return 'success'
}

const getOverallSecurityStatus = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'Critical'
  if (cvssScore >= 7.0) return 'High Risk'
  if (cvssScore >= 4.0) return 'Medium Risk'
  return 'Low Risk'
}

const getOverallSecurityIcon = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'mdi-alert-circle'
  if (cvssScore >= 7.0) return 'mdi-alert'
  if (cvssScore >= 4.0) return 'mdi-information'
  return 'mdi-check-circle'
}
</script>

<style scoped>
.font-weight-black {
  font-weight: 900;
}
.h-100 {
  height: 100%;
}
</style> 