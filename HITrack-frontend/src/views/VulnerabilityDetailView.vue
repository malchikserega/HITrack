<template>
  <v-container fluid class="pa-6 vulnerability-detail-container">
    <v-row v-if="loading">
      <v-col cols="12" class="text-center">
        <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
        <div class="mt-4 text-h6">Loading vulnerability details...</div>
      </v-col>
    </v-row>
    
    <v-row v-else-if="!vulnerability">
      <v-col cols="12" class="text-center">
        <v-icon size="64" color="error" class="mb-4">mdi-alert-circle</v-icon>
        <div class="text-h6 mb-2">Vulnerability not found</div>
        <div class="text-body-2 text-grey">The requested vulnerability could not be loaded.</div>
      </v-col>
    </v-row>
    
    <v-row v-else>
      <v-col cols="12">
        <!-- Header -->
        <div class="d-flex justify-space-between align-center mb-6">
          <div>
            <h1 class="text-h3 font-weight-bold mb-2">{{ vulnerability?.vulnerability_id }}</h1>
            <div class="d-flex align-center">
              <v-chip :color="getSeverityColor(vulnerability?.severity)" size="large" class="mr-3">
                {{ vulnerability?.severity }}
              </v-chip>
              <v-chip v-if="vulnerability?.details?.cisa_kev_known_exploited" color="error" size="small">
                <v-icon class="mr-1">mdi-shield-alert</v-icon>
                CISA KEV
              </v-chip>
              <v-chip v-if="vulnerability?.details?.exploit_available" color="error" size="small" class="ml-2">
                <v-icon class="mr-1">mdi-bug</v-icon>
                Exploit Available
              </v-chip>
            </div>
          </div>
        </div>

        <!-- Unified Security Metrics Card -->
        <v-card class="mb-6" elevation="3">
          <v-card-title class="text-h5 pa-6 pb-4">
            <v-icon class="mr-3" color="primary">mdi-shield-alert</v-icon>
            Security Metrics
          </v-card-title>
          <v-card-text class="pa-6 pt-0">
            <v-row>
              <!-- CVSS Score Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" :color="vulnerability?.details?.cve_details_score ? getCvssColor(vulnerability.details.cve_details_score) : 'grey'" class="mr-3">
                      mdi-chart-box
                    </v-icon>
                    <div>
                      <div class="text-h4 font-weight-black" :class="vulnerability?.details?.cve_details_score ? getCvssTextColor(vulnerability.details.cve_details_score) : ''">
                        {{ vulnerability?.details?.cve_details_score || 'N/A' }}
                      </div>
                      <div class="text-caption text-grey">CVSS Score</div>
                    </div>
                  </div>
                  <v-progress-linear
                    v-if="vulnerability?.details?.cve_details_score"
                    :model-value="(vulnerability.details.cve_details_score / 10) * 100"
                    :color="getCvssColor(vulnerability.details.cve_details_score)"
                    height="8"
                    rounded
                  ></v-progress-linear>
                </div>
              </v-col>

              <!-- EPSS Score Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" color="info" class="mr-3">mdi-chart-line</v-icon>
                    <div>
                      <div class="text-h4 font-weight-black">
                        {{ vulnerability?.epss ? (vulnerability.epss * 100).toFixed(1) + '%' : 'N/A' }}
                      </div>
                      <div class="text-caption text-grey">EPSS Score</div>
                    </div>
                  </div>
                  <v-progress-linear
                    v-if="vulnerability?.epss"
                    :model-value="vulnerability.epss * 100"
                    color="info"
                    height="8"
                    rounded
                  ></v-progress-linear>
                </div>
              </v-col>

              <!-- CISA KEV Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" class="mr-3">
                      {{ vulnerability?.details?.cisa_kev_known_exploited ? 'mdi-shield-alert' : 'mdi-shield-check' }}
                    </v-icon>
                    <div>
                      <div class="text-h4 font-weight-black" :class="vulnerability?.details?.cisa_kev_known_exploited ? 'text-error' : 'text-success'">
                        {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Yes' : 'No' }}
                      </div>
                      <div class="text-caption text-grey">CISA KEV</div>
                    </div>
                  </div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" size="small" variant="outlined">
                    {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Known Exploited' : 'Not in KEV' }}
                  </v-chip>
                </div>
              </v-col>

              <!-- Exploit Available Section -->
              <v-col cols="12" md="6" lg="3">
                <div class="text-center">
                  <div class="d-flex align-center justify-center mb-3">
                    <v-icon size="40" :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" class="mr-3">
                      {{ vulnerability?.details?.exploit_available ? 'mdi-bug' : 'mdi-shield-check' }}
                    </v-icon>
                    <div>
                      <div class="text-h4 font-weight-black" :class="vulnerability?.details?.exploit_available ? 'text-error' : 'text-success'">
                        {{ vulnerability?.details?.exploit_available ? 'Yes' : 'No' }}
                      </div>
                      <div class="text-caption text-grey">Exploit Available</div>
                    </div>
                  </div>
                  <v-chip :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" size="small" variant="outlined">
                    {{ vulnerability?.details?.exploit_available ? 'Available' : 'Not Available' }}
                  </v-chip>
                </div>
              </v-col>
            </v-row>

            <!-- Security Status Bar -->
            <v-divider class="my-4"></v-divider>
            <div class="d-flex justify-space-between align-center">
              <div class="text-subtitle-2 text-grey">Overall Security Status:</div>
              <div class="d-flex align-center">
                <v-chip 
                  :color="getOverallSecurityColor()" 
                  size="small" 
                  class="mr-2"
                >
                  {{ getOverallSecurityStatus() }}
                </v-chip>
                <v-icon :color="getOverallSecurityColor()" size="20">
                  {{ getOverallSecurityIcon() }}
                </v-icon>
              </div>
            </div>
          </v-card-text>
        </v-card>

        <!-- Main Content -->
        <v-row class="main-content-row">
          <!-- Left Column -->
          <v-col cols="12" lg="8" class="main-content-col">
            <!-- Tabs -->
            <v-card class="mb-6" elevation="2">
              <v-tabs v-model="activeTab" color="primary" grow>
                <v-tab value="details">
                  <v-icon class="mr-2">mdi-information</v-icon>
                  Details
                </v-tab>
                <v-tab value="components">
                  <v-icon class="mr-2">mdi-package-variant</v-icon>
                  Components
                </v-tab>
                <v-tab value="images">
                  <v-icon class="mr-2">mdi-docker</v-icon>
                  Images
                </v-tab>
              </v-tabs>
            </v-card>

            <!-- Tab Content -->
            <v-window v-model="activeTab">
              <!-- Details Tab -->
              <v-window-item value="details">
            <!-- Description Section -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-text</v-icon>
                Description
              </v-card-title>
              <v-card-text>
                <div v-if="vulnerability?.details?.cisa_kev_short_description" class="mb-4">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">CISA KEV Description</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_short_description }}</div>
                </div>
                <div v-if="vulnerability?.details?.cve_details_summary" class="mb-4">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">CVE Details Summary</div>
                  <div class="text-body-1">{{ vulnerability.details.cve_details_summary }}</div>
                </div>
                <div v-if="vulnerability?.description">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">System Description</div>
                  <div class="text-body-1">{{ vulnerability.description }}</div>
                </div>
                <div v-if="!vulnerability?.details?.cisa_kev_short_description && !vulnerability?.details?.cve_details_summary && !vulnerability?.description" class="text-center py-8">
                  <v-icon size="64" color="grey" class="mb-4">mdi-text-off</v-icon>
                  <div class="text-h6 text-grey">No description available</div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CISA KEV Information -->
            <v-card v-if="vulnerability?.details?.cisa_kev_known_exploited" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="error">mdi-shield-alert</v-icon>
                CISA KEV Information
              </v-card-title>
              <v-card-text>
                <v-row>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Vendor/Project</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_vendor_project || 'N/A' }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Product</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_product || 'N/A' }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Vulnerability Name</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_vulnerability_name || 'N/A' }}</div>
                    </div>
                  </v-col>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Date Added</div>
                      <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability.details.cisa_kev_date_added) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Due Date</div>
                      <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability.details.cisa_kev_due_date) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Ransomware Use</div>
                      <v-chip :color="vulnerability.details.cisa_kev_ransomware_use === 'Known' ? 'error' : 'success'" size="small">
                        {{ vulnerability.details.cisa_kev_ransomware_use || 'Unknown' }}
                      </v-chip>
                    </div>
                  </v-col>
                </v-row>
                <div v-if="vulnerability.details.cisa_kev_required_action" class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Required Action</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_required_action }}</div>
                </div>
                <div v-if="vulnerability.details.cisa_kev_notes" class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Notes</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_notes }}</div>
                </div>
                <div v-if="vulnerability.details.cisa_kev_cwes?.length">
                  <div class="text-subtitle-2 text-grey mb-1">CWEs</div>
                  <div class="d-flex flex-wrap">
                    <v-chip v-for="cwe in vulnerability.details.cisa_kev_cwes" :key="cwe" size="small" class="mr-2 mb-2" color="warning">
                      {{ cwe }}
                    </v-chip>
                  </div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CVE Details -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-chart-timeline-variant</v-icon>
                CVE Details
              </v-card-title>
              <v-card-text>
                <v-row>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">CVSS Score</div>
                      <div class="d-flex align-center">
                        <v-chip v-if="vulnerability?.details?.cve_details_score" :color="getCvssColor(vulnerability.details.cve_details_score)" size="small" class="mr-2">
                          {{ vulnerability.details.cve_details_score }}
                        </v-chip>
                        <span v-else class="text-grey">N/A</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Severity</div>
                      <v-chip v-if="vulnerability?.details?.cve_details_severity" :color="getSeverityColor(vulnerability.details.cve_details_severity)" size="small">
                        {{ vulnerability.details.cve_details_severity }}
                      </v-chip>
                      <span v-else class="text-grey">N/A</span>
                    </div>
                  </v-col>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Published</div>
                      <div class="text-body-1">{{ formatDate(vulnerability?.details?.cve_details_published_date) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Updated</div>
                      <div class="text-body-1">{{ formatDate(vulnerability?.details?.cve_details_updated_date) }}</div>
                    </div>
                  </v-col>
                </v-row>
                <div v-if="vulnerability?.details?.cve_details_references?.length">
                  <div class="d-flex align-center justify-space-between mb-2">
                    <div class="text-subtitle-2 text-grey">References</div>
                    <v-btn 
                      variant="text" 
                      size="small" 
                      @click="showReferences = !showReferences"
                      class="text-caption"
                    >
                      <v-icon size="16" class="mr-1">
                        {{ showReferences ? 'mdi-chevron-up' : 'mdi-chevron-down' }}
                      </v-icon>
                      {{ showReferences ? 'Hide' : 'Show' }} ({{ vulnerability.details.cve_details_references.length }})
                    </v-btn>
                  </div>
                  <v-expand-transition>
                    <div v-if="showReferences" class="d-flex flex-column">
                      <a v-for="(ref, index) in vulnerability.details.cve_details_references" :key="index" 
                         :href="ref" target="_blank" class="text-body-2 text-primary mb-1">
                        {{ ref }}
                      </a>
                    </div>
                  </v-expand-transition>
                </div>
              </v-card-text>
            </v-card>

            <!-- Exploit Information -->
            <v-card v-if="vulnerability?.details?.exploit_available" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="error">mdi-bug</v-icon>
                Exploit Information
              </v-card-title>
              <v-card-text>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Status</div>
                  <div class="d-flex align-center">
                    <v-chip color="error" size="small" class="mr-2">
                      <v-icon class="mr-1">mdi-bug</v-icon>
                      Available
                    </v-chip>
                    <v-chip v-if="vulnerability.details.exploit_public" color="warning" size="small" class="mr-2">
                      Public
                    </v-chip>
                    <v-chip v-if="vulnerability.details.exploit_verified" color="success" size="small">
                      Verified
                    </v-chip>
                  </div>
                </div>
                <div v-if="vulnerability?.details?.exploit_links?.length">
                  <div class="text-subtitle-2 text-grey mb-2">Exploit Links</div>
                  <div class="d-flex flex-column">
                    <a v-for="(link, index) in vulnerability.details.exploit_links" :key="index" 
                       :href="link" target="_blank" class="text-body-2 text-primary mb-1">
                      {{ link }}
                    </a>
                  </div>
                </div>
              </v-card-text>
            </v-card>
              </v-window-item>

              <!-- Components Tab -->
              <v-window-item value="components">
                <v-card class="mb-6" elevation="2">
                  <v-card-title class="text-h5">
                    <v-icon class="mr-3" color="primary">mdi-package-variant</v-icon>
                    Affected Components
                  </v-card-title>
                  <v-card-text>
                    <div v-if="componentsLoading" class="text-center py-6">
                      <v-progress-circular indeterminate color="primary" size="48"></v-progress-circular>
                      <div class="mt-3 text-body-1">Loading affected components...</div>
                    </div>
                    
                    <div v-else-if="!components || components.length === 0" class="text-center py-6">
                      <v-icon size="48" color="grey" class="mb-3">mdi-package-variant-closed</v-icon>
                      <div class="text-body-1 text-grey mb-1">No affected components found</div>
                      <div class="text-caption text-grey">This vulnerability was not detected in any scanned components.</div>
                    </div>
                    
                    <div v-else>
                      <div class="d-flex justify-space-between align-center mb-3">
                        <div class="text-body-2 text-grey">
                          {{ components.length }} component{{ components.length !== 1 ? 's' : '' }} found
                        </div>
                        <v-btn
                          variant="text"
                          size="small"
                          @click="loadComponents"
                          :loading="componentsLoading"
                          density="compact"
                        >
                          <v-icon size="16" class="mr-1">mdi-refresh</v-icon>
                          Refresh
                        </v-btn>
                      </div>
                      
                      <!-- Components Table -->
                      <v-table class="components-table">
                        <thead>
                          <tr>
                            <th class="text-left">Component</th>
                            <th class="text-left">Type</th>
                            <th class="text-left">Version</th>
                            <th class="text-center">Images</th>
                            <th class="text-center">Vulnerabilities</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="component in components" :key="component.uuid" class="component-row">
                            <td class="component-name-cell">
                              <div class="d-flex align-center">
                                <v-avatar size="32" color="grey-darken-3" class="mr-2">
                                  <v-icon color="white" size="16">mdi-package-variant</v-icon>
                                </v-avatar>
                                <span class="font-weight-bold">{{ component.component.name }}</span>
                              </div>
                            </td>
                            <td class="type-cell">
                              <v-chip 
                                size="small" 
                                color="info" 
                                variant="outlined"
                                class="component-type-chip"
                                :title="component.component.type"
                              >
                                <v-icon size="12" class="mr-1">mdi-tag</v-icon>
                                {{ component.component.type }}
                              </v-chip>
                            </td>
                            <td class="version-cell">
                              <div class="version-container">
                                <v-chip 
                                  size="small" 
                                  color="primary" 
                                  variant="outlined"
                                  class="version-chip"
                                  :title="component.version"
                                >
                                  <v-icon size="12" class="mr-1">mdi-pound</v-icon>
                                  {{ component.version }}
                                </v-chip>
                                <div v-if="component.version && component.version.length > 25" class="version-full mt-1">
                                  {{ component.version }}
                                </div>
                              </div>
                            </td>
                            <td class="text-center images-cell">
                              <v-chip 
                                color="success" 
                                size="small" 
                                class="usage-chip"
                                :title="`Used in ${component.used_count} images`"
                                variant="elevated"
                              >
                                <v-icon size="14" class="mr-1">mdi-docker</v-icon>
                                {{ component.used_count }}
                              </v-chip>
                            </td>
                            <td class="text-center vulns-cell">
                              <v-chip 
                                color="warning" 
                                size="small" 
                                class="vulnerabilities-chip"
                                :title="`Has ${component.vulnerabilities_count} vulnerabilities`"
                                variant="elevated"
                              >
                                <v-icon size="14" class="mr-1">mdi-shield-alert</v-icon>
                                {{ component.vulnerabilities_count }}
                              </v-chip>
                            </td>
                          </tr>
                        </tbody>
                      </v-table>
                    </div>
                  </v-card-text>
                </v-card>
              </v-window-item>

              <!-- Images Tab -->
              <v-window-item value="images">
                <v-card class="mb-6" elevation="2">
                  <v-card-title class="text-h5">
                    <v-icon class="mr-3" color="primary">mdi-docker</v-icon>
                    Affected Images
                  </v-card-title>
                  <v-card-text>
                    <div v-if="imagesLoading" class="text-center py-6">
                      <v-progress-circular indeterminate color="primary" size="48"></v-progress-circular>
                      <div class="mt-3 text-body-1">Loading affected images...</div>
                    </div>
                    
                    <div v-else-if="!images || images.length === 0" class="text-center py-6">
                      <v-icon size="48" color="grey" class="mb-3">mdi-docker-off</v-icon>
                      <div class="text-body-1 text-grey mb-1">No affected images found</div>
                      <div class="text-caption text-grey">This vulnerability was not detected in any scanned images.</div>
                    </div>
                    
                    <div v-else>
                      <div class="d-flex justify-space-between align-center mb-3">
                        <div class="text-body-2 text-grey">
                          {{ images.length }} image{{ images.length !== 1 ? 's' : '' }} found
                        </div>
                        <v-btn
                          variant="text"
                          size="small"
                          @click="loadImages"
                          :loading="imagesLoading"
                          density="compact"
                        >
                          <v-icon size="16" class="mr-1">mdi-refresh</v-icon>
                          Refresh
                        </v-btn>
                      </div>
                      
                      <v-list class="pa-0">
                        <v-list-item
                          v-for="image in images"
                          :key="image.uuid"
                          :to="`/images/${image.uuid}`"
                          class="mb-4 pa-4 image-card"
                          style="word-break: break-word; overflow-wrap: break-word;"
                        >
                          <template v-slot:prepend>
                            <v-avatar size="48" color="primary" class="mr-4">
                              <v-icon color="white" size="24">mdi-docker</v-icon>
                            </v-avatar>
                          </template>
                          
                          <v-list-item-title class="font-weight-bold text-truncate mb-2" :title="image.name">
                            {{ image.name }}
                          </v-list-item-title>
                          
                          <v-list-item-subtitle class="pa-0">
                            <!-- Repository and Tag Info -->
                            <div v-if="image.repository_info" class="d-flex align-center flex-wrap mb-3">
                              <v-chip 
                                size="small" 
                                color="info" 
                                variant="outlined"
                                class="mr-2 mb-1 repository-chip"
                                :title="image.repository_info.repository_name"
                              >
                                <v-icon size="14" class="mr-1">mdi-source-repository</v-icon>
                                {{ image.repository_info.repository_name }}
                              </v-chip>
                              <v-chip 
                                size="small" 
                                color="secondary" 
                                variant="outlined"
                                class="mb-1 tag-chip"
                                :title="image.repository_info.tag"
                              >
                                <v-icon size="14" class="mr-1">mdi-tag</v-icon>
                                {{ image.repository_info.tag }}
                              </v-chip>
                            </div>
                            
                            <!-- Status, Digest and Vulnerabilities -->
                            <div class="d-flex flex-column">
                              <div class="d-flex align-center flex-wrap mb-2">
                                <v-chip 
                                  :color="getImageScanStatusColor(image.scan_status)" 
                                  size="small" 
                                  class="mr-3 mb-1 status-chip"
                                >
                                  <v-icon size="14" class="mr-1">
                                    {{ getStatusIcon(image.scan_status) }}
                                  </v-icon>
                                  {{ getShortStatus(image.scan_status) }}
                                </v-chip>
                                <span v-if="image.digest" class="text-caption text-grey digest-text mb-1" :title="image.digest">
                                  {{ image.digest.substring(0, 12) }}...
                                </span>
                              </div>
                              
                              <!-- Vulnerability Count -->
                              <div class="d-flex align-center vulnerability-count">
                                <v-icon size="18" color="error" class="mr-2">mdi-shield-alert</v-icon>
                                <span class="text-body-2 font-weight-bold">
                                  {{ image.findings }} vulns
                                </span>
                              </div>
                            </div>
                          </v-list-item-subtitle>
                          
                          <template v-slot:append>
                            <v-icon size="20" color="grey">mdi-chevron-right</v-icon>
                          </template>
                        </v-list-item>
                      </v-list>
                    </div>
                  </v-card-text>
                </v-card>
              </v-window-item>
            </v-window>
          </v-col>

          <!-- Right Column -->
          <v-col cols="12" lg="4" class="main-content-col">
            <!-- Quick Info -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-information</v-icon>
                Quick Info
              </v-card-title>
              <v-card-text>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Vulnerability Type</div>
                  <div class="text-body-1 font-weight-medium">{{ vulnerability?.vulnerability_type }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Created</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.created_at) }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Last Updated</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.updated_at) }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Data Source</div>
                  <div class="text-body-1 font-weight-medium">{{ vulnerability?.details?.data_source || 'N/A' }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Details Updated</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.details?.last_updated) }}</div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CVSS Score Card -->
            <v-card v-if="vulnerability?.details?.cve_details_score" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-chart-box</v-icon>
                CVSS Score
              </v-card-title>
              <v-card-text>
                <div class="text-center">
                  <div class="text-h2 font-weight-black mb-2" :class="getCvssTextColor(vulnerability.details.cve_details_score)">
                    {{ vulnerability.details.cve_details_score }}
                  </div>
                  <v-chip :color="getCvssColor(vulnerability.details.cve_details_score)" size="large">
                    {{ vulnerability.details.cve_details_severity }}
                  </v-chip>
                </div>
              </v-card-text>
            </v-card>

            <!-- Security Status -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-shield-check</v-icon>
                Security Status
              </v-card-title>
              <v-card-text>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">CISA KEV</div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Known Exploited' : 'Not in KEV' }}
                  </v-chip>
                </div>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Exploit Available</div>
                  <v-chip :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.exploit_available ? 'Available' : 'Not Available' }}
                  </v-chip>
                </div>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Ransomware Use</div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_ransomware_use === 'Known' ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.cisa_kev_ransomware_use || 'Unknown' }}
                  </v-chip>
                </div>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue'
import { useRoute } from 'vue-router'
import type { Vulnerability, ComponentVersion } from '@/types/interfaces'

const route = useRoute()
const vulnerability = ref<Vulnerability | null>(null)
const loading = ref(true)
const showReferences = ref(false)
const activeTab = ref('details')
const images = ref<any[]>([])
const imagesLoading = ref(false)
const components = ref<ComponentVersion[]>([])
const componentsLoading = ref(false)

onMounted(async () => {
  try {
    const vulnerabilityId = route.params.uuid
    if (!vulnerabilityId) {
      console.error('No vulnerability UUID provided')
      return
    }
    
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerabilityId}/`, {
      headers
    })
    
    if (response.ok) {
      vulnerability.value = await response.json()
    } else {
      console.error('Failed to fetch vulnerability:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error fetching vulnerability:', error)
  } finally {
    loading.value = false
  }
})

const getCvssColor = (score: number): string => {
  if (score >= 9.0) return 'error'
  if (score >= 7.0) return 'warning'
  if (score >= 4.0) return 'info'
  return 'success'
}

const getCvssTextColor = (score: number): string => {
  if (score >= 9.0) return 'text-error'
  if (score >= 7.0) return 'text-warning'
  if (score >= 4.0) return 'text-info'
  return 'text-success'
}

const getSeverityColor = (severity?: string): string => {
  if (!severity) return 'grey'
  switch (severity.toUpperCase()) {
    case 'CRITICAL': return 'error'
    case 'HIGH': return 'warning'
    case 'MEDIUM': return 'info'
    case 'LOW': return 'success'
    default: return 'grey'
  }
}

const formatDate = (dateString: string | null | undefined): string => {
  if (!dateString) return 'N/A'
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

const getOverallSecurityColor = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'error'
  if (cvssScore >= 7.0) return 'warning'
  if (cvssScore >= 4.0) return 'info'
  return 'success'
}

const getOverallSecurityStatus = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'Critical'
  if (cvssScore >= 7.0) return 'High Risk'
  if (cvssScore >= 4.0) return 'Medium Risk'
  return 'Low Risk'
}

const getOverallSecurityIcon = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'mdi-alert-circle'
  if (cvssScore >= 7.0) return 'mdi-alert'
  if (cvssScore >= 4.0) return 'mdi-information'
  return 'mdi-check-circle'
}

const loadComponents = async () => {
  if (!vulnerability.value) return
  
  componentsLoading.value = true
  try {
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerability.value.uuid}/components/`, {
      headers
    })
    
    if (response.ok) {
      const data = await response.json()
      // Handle both paginated and non-paginated responses
      components.value = data.results || data
    } else {
      console.error('Failed to fetch components:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error fetching components:', error)
  } finally {
    componentsLoading.value = false
  }
}

const loadImages = async () => {
  if (!vulnerability.value) return
  
  imagesLoading.value = true
  try {
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerability.value.uuid}/images/`, {
      headers
    })
    
    if (response.ok) {
      const data = await response.json()
      // Handle both paginated and non-paginated responses
      images.value = data.results || data
    } else {
      console.error('Failed to fetch images:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error fetching images:', error)
  } finally {
    imagesLoading.value = false
  }
}

const getImageScanStatusColor = (status: string): string => {
  switch (status) {
    case 'success': return 'success'
    case 'error': return 'error'
    case 'in_process': return 'warning'
    case 'pending': return 'info'
    default: return 'grey'
  }
}

const getShortStatus = (status: string): string => {
  switch (status) {
    case 'success': return 'OK'
    case 'error': return 'ERR'
    case 'in_process': return 'RUN'
    case 'pending': return 'PND'
    default: return status.substring(0, 3).toUpperCase()
  }
}

const getStatusIcon = (status: string): string => {
  switch (status) {
    case 'success': return 'mdi-check-circle'
    case 'error': return 'mdi-alert-circle'
    case 'in_process': return 'mdi-sync'
    case 'pending': return 'mdi-clock'
    default: return 'mdi-help-circle'
  }
}

const copyToClipboard = async (text: string) => {
  try {
    await navigator.clipboard.writeText(text)
  } catch (err) {
    console.error('Failed to copy to clipboard:', err)
  }
}

// Watch for tab changes to load images when needed
watch(activeTab, (newTab) => {
  if (newTab === 'images' && vulnerability.value && images.value.length === 0) {
    loadImages()
  }
  if (newTab === 'components' && vulnerability.value && components.value.length === 0) {
    loadComponents()
  }
})
</script>

<style scoped>
.vulnerability-detail-container {
  max-width: 100% !important;
  overflow-x: hidden !important;
  min-width: 0 !important;
}

.main-content-row {
  max-width: 100% !important;
  overflow-x: hidden !important;
  min-width: 0 !important;
}

.main-content-col {
  max-width: 100% !important;
  overflow-x: hidden !important;
  min-width: 0 !important;
}

.v-list-item__title {
  font-size: 1.1rem !important;
  line-height: 1.4 !important;
  color: #1a202c !important;
  font-weight: 700 !important;
  word-break: break-word !important;
}

.v-list-item__subtitle {
  font-size: 0.9rem !important;
  line-height: 1.4 !important;
  color: #4a5568 !important;
  word-break: break-word !important;
}
.font-weight-black {
  font-weight: 900;
}
.h-100 {
  height: 100%;
}


.image-card {
  border-radius: 16px !important;
  margin-bottom: 12px !important;
  transition: all 0.3s ease-in-out !important;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
  border: 1px solid rgba(0,0,0,0.06) !important;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
}

.image-card:hover {
  background: linear-gradient(135deg, #ffffff 0%, #f0f2f5 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 25px rgba(0,0,0,0.12) !important;
  border-color: rgba(0,0,0,0.1) !important;
}

.text-truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Улучшенная типографика */
.v-list-item__title {
  font-size: 1.1rem !important;
  line-height: 1.4 !important;
  color: #1a202c !important;
  font-weight: 700 !important;
}

.v-list-item__subtitle {
  font-size: 0.9rem !important;
  line-height: 1.4 !important;
  color: #4a5568 !important;
}

/* Стили для чипов */
.repository-chip {
  max-width: 200px !important;
  overflow: hidden !important;
}

.tag-chip {
  max-width: 120px !important;
  overflow: hidden !important;
}

.status-chip {
  min-width: 80px !important;
  font-weight: 600 !important;
}

.digest-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 2px 6px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
}

.vulnerability-count {
  background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%) !important;
  padding: 6px 12px !important;
  border-radius: 20px !important;
  border: 1px solid #fc8181 !important;
}


.image-card {
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.component-card {
  border-radius: 16px !important;
  margin-bottom: 12px !important;
  transition: all 0.3s ease-in-out !important;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
  border: 1px solid rgba(0,0,0,0.06) !important;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
}

.component-card:hover {
  background: linear-gradient(135deg, #ffffff 0%, #f0f2f5 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 25px rgba(0,0,0,0.12) !important;
  border-color: rgba(0,0,0,0.1) !important;
}

.component-type-chip {
  max-width: 200px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
}

.version-chip {
  max-width: 300px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
}

.chip-container {
  min-width: 0 !important;
  width: 100% !important;
}

.usage-vuln-container {
  min-width: 0 !important;
  width: 100% !important;
  gap: 8px !important;
}

/* Table Styles */
.components-table {
  border-radius: 8px !important;
  overflow: hidden !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

.components-table thead th {
  background-color: #f8f9fa !important;
  font-weight: 600 !important;
  font-size: 0.875rem !important;
  color: #374151 !important;
  padding: 12px 16px !important;
  border-bottom: 2px solid #e5e7eb !important;
}

.components-table tbody td {
  padding: 12px 16px !important;
  border-bottom: 1px solid #f3f4f6 !important;
  vertical-align: middle !important;
}

.component-row:hover {
  background-color: #f9fafb !important;
}

.component-name-cell {
  min-width: 200px !important;
  max-width: 300px !important;
}

.type-cell {
  min-width: 120px !important;
  max-width: 150px !important;
}

.version-cell {
  min-width: 150px !important;
  max-width: 250px !important;
}

.images-cell,
.vulns-cell {
  min-width: 80px !important;
  max-width: 100px !important;
}



.version-container {
  display: flex !important;
  flex-direction: column !important;
  gap: 4px !important;
}

.version-full {
  word-break: break-all !important;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 6px 10px !important;
  border-radius: 6px !important;
  border: 1px solid #e2e8f0 !important;
  margin-top: 6px !important;
  font-size: 0.8rem !important;
  line-height: 1.3 !important;
  color: #2d3748 !important;
  font-weight: 500 !important;
}

.usage-chip {
  min-width: 100px !important;
  font-weight: 600 !important;
  font-size: 0.8rem !important;
  height: 28px !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.vulnerabilities-chip {
  min-width: 100px !important;
  font-weight: 600 !important;
  font-size: 0.8rem !important;
  height: 28px !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.purl-container {
  max-width: 100% !important;
  overflow: hidden !important;
}

.purl-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 4px 8px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
  word-break: break-all !important;
  display: block !important;
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
}

.copy-btn {
  min-width: 24px !important;
  height: 24px !important;
  padding: 0 !important;
}

.cpe-container {
  max-width: 100% !important;
  overflow: hidden !important;
}

.cpe-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 4px 8px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
  word-break: break-all !important;
  display: block !important;
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
}

.repository-chip {
  max-width: 200px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

.tag-chip {
  max-width: 120px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

.status-chip {
  min-width: 80px !important;
  font-weight: 600 !important;
}

.digest-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 2px 6px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
  max-width: 150px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

.vulnerability-count {
  background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%) !important;
  padding: 6px 12px !important;
  border-radius: 20px !important;
  border: 1px solid #fc8181 !important;
  flex-shrink: 0 !important;
}


@media (max-width: 768px) {
  .repository-chip {
    max-width: 120px !important;
  }
  
  .tag-chip {
    max-width: 80px !important;
  }
  
  .component-type-chip {
    max-width: 150px !important;
  }
  
  .version-chip {
    max-width: 200px !important;
  }
  
  .usage-chip,
  .vulnerabilities-chip {
    min-width: 90px !important;
    font-size: 0.75rem !important;
    height: 26px !important;
  }
  
  /* Table responsive */
  .components-table {
    font-size: 0.8rem !important;
  }
  
  .components-table thead th {
    padding: 8px 12px !important;
    font-size: 0.8rem !important;
  }
  
  .components-table tbody td {
    padding: 8px 12px !important;
  }
  
  .component-name-cell {
    min-width: 150px !important;
    max-width: 200px !important;
  }
  
  .type-cell {
    min-width: 100px !important;
    max-width: 120px !important;
  }
  
  .version-cell {
    min-width: 120px !important;
    max-width: 180px !important;
  }
  
  .images-cell,
  .vulns-cell {
    min-width: 60px !important;
    max-width: 80px !important;
  }
  

  
  .version-full {
    font-size: 0.7rem !important;
    padding: 2px 6px !important;
  }
  
  .purl-text {
    font-size: 0.7rem !important;
    padding: 2px 6px !important;
  }
  
  .cpe-text {
    font-size: 0.7rem !important;
    padding: 2px 6px !important;
  }
  
  .digest-text {
    max-width: 100px !important;
    font-size: 0.65rem !important;
  }
  
  .v-list-item__title {
    font-size: 0.9rem !important;
  }
  
  .v-list-item__subtitle {
    font-size: 0.8rem !important;
  }
}

@media (max-width: 480px) {
  .repository-chip {
    max-width: 100px !important;
  }
  
  .tag-chip {
    max-width: 60px !important;
  }
  
  .component-type-chip {
    max-width: 100px !important;
  }
  
  .version-chip {
    max-width: 150px !important;
  }
  
  .digest-text {
    max-width: 80px !important;
    font-size: 0.6rem !important;
  }
  
  .v-list-item__title {
    font-size: 0.85rem !important;
  }
  
  .v-list-item__subtitle {
    font-size: 0.75rem !important;
  }
  
  .usage-chip,
  .vulnerabilities-chip,
  .status-chip {
    min-width: 80px !important;
    font-size: 0.75rem !important;
    height: 26px !important;
  }
}
</style> 