<template>
  <v-container fluid class="pa-6 vulnerability-detail-container">
    <v-row v-if="loading">
      <v-col cols="12" class="text-center">
        <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
        <div class="mt-4 text-h6">Loading vulnerability details...</div>
      </v-col>
    </v-row>
    
    <v-row v-else-if="!vulnerability">
      <v-col cols="12" class="text-center">
        <v-icon size="64" color="error" class="mb-4">mdi-alert-circle</v-icon>
        <div class="text-h6 mb-2">Vulnerability not found</div>
        <div class="text-body-2 text-grey">The requested vulnerability could not be loaded.</div>
      </v-col>
    </v-row>
    
    <v-row v-else>
      <v-col cols="12">
        <!-- Back Button -->
        <v-btn 
          variant="text" 
          @click="goBack" 
          class="mb-4"
          prepend-icon="mdi-arrow-left"
        >
          Back
        </v-btn>
        
        <!-- Header -->
        <div class="d-flex justify-space-between align-center mb-6">
          <div>
            <div class="d-flex align-center mb-2">
              <h1 class="text-h3 font-weight-bold mr-3">{{ vulnerability?.vulnerability_id }}</h1>
              
              <!-- Update Vulnerability Details Button -->
              <v-tooltip location="top" open-delay="500">
                <template v-slot:activator="{ props }">
                  <v-btn
                    v-bind="props"
                    icon
                    size="x-small"
                    color="primary"
                    variant="elevated"
                    :loading="updatingDetails"
                    @click="updateVulnerabilityDetails"
                    class="update-details-btn"
                    elevation="2"
                  >
                    <v-icon size="18" class="update-icon">mdi-refresh</v-icon>
                  </v-btn>
                </template>
                <span class="tooltip-text">Update vulnerability details from external sources</span>
              </v-tooltip>
            </div>
            
            <div class="d-flex align-center">
              <v-chip :color="getSeverityColor(vulnerability?.severity)" size="large" class="mr-3">
                {{ vulnerability?.severity }}
              </v-chip>
              <v-chip v-if="vulnerability?.details?.cisa_kev_known_exploited" color="error" size="small">
                <v-icon class="mr-1">mdi-shield-alert</v-icon>
                CISA KEV
              </v-chip>
              <v-chip v-if="vulnerability?.details?.exploit_available" color="error" size="small" class="ml-2">
                <v-icon class="mr-1">mdi-bug</v-icon>
                Exploit Available
              </v-chip>
            </div>
          </div>
        </div>

        <!-- Security Metrics Card -->
        <v-card class="security-metrics-card mb-6" elevation="2">
          <v-card-title class="d-flex align-center pa-6 pb-4">
            <v-icon size="28" color="primary" class="mr-3">mdi-shield-alert</v-icon>
            <span class="text-h5 font-weight-bold">Security Metrics</span>
          </v-card-title>
          
          <v-card-text class="pa-6 pt-0">
            <v-row class="metrics-grid">
              <!-- CVSS Score Section -->
              <v-col cols="12" md="6" lg="3" class="metric-column">
                <div class="metric-card cvss-metric">
                  <div class="metric-header">
                    <v-icon size="32" color="primary" class="metric-icon">mdi-chart-bar</v-icon>
                    <div class="metric-title">CVSS Score</div>
                    <v-tooltip location="top" max-width="300">
                      <template v-slot:activator="{ props }">
                        <v-icon 
                          v-bind="props" 
                          size="16" 
                          color="grey" 
                          class="ml-2 info-icon"
                        >
                          mdi-information-outline
                        </v-icon>
                      </template>
                      <div class="tooltip-content">
                        <div class="tooltip-title font-weight-bold mb-2">CVSS Score</div>
                        <div class="tooltip-text">
                          <strong>CVSS (Common Vulnerability Scoring System)</strong> - a standardized system for rating the severity of vulnerabilities.
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Scale:</strong> 0.0 (low) - 10.0 (critical)
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Levels:</strong> Low (0.1-3.9), Medium (4.0-6.9), High (7.0-8.9), Critical (9.0-10.0)
                        </div>
                      </div>
                    </v-tooltip>
                  </div>
                  
                                    <div class="metric-value">
                    {{ vulnerability?.details?.cve_details_score || 'N/A' }}
                  </div>
                  
                  <div class="metric-progress">
                    <v-progress-linear
                      v-if="vulnerability?.details?.cve_details_score"
                      :model-value="vulnerability.details.cve_details_score * 10"
                      color="primary"
                      height="6"
                      rounded
                      class="progress-bar"
                    ></v-progress-linear>
                  </div>
                </div>
              </v-col>

              <!-- EPSS Score Section -->
              <v-col cols="12" md="6" lg="3" class="metric-column">
                <div class="metric-card epss-metric">
                  <div class="metric-header">
                    <v-icon size="32" color="info" class="metric-icon">mdi-chart-line</v-icon>
                    <div class="metric-title">EPSS Score</div>
                    <v-tooltip location="top" max-width="300">
                      <template v-slot:activator="{ props }">
                        <v-icon 
                          v-bind="props" 
                          size="16" 
                          color="grey" 
                          class="ml-2 info-icon"
                        >
                          mdi-information-outline
                        </v-icon>
                      </template>
                      <div class="tooltip-content">
                        <div class="tooltip-title font-weight-bold mb-2">EPSS Score</div>
                        <div class="tooltip-text">
                          <strong>EPSS (Exploit Prediction Scoring System)</strong> - a system that predicts the probability of a vulnerability being exploited within the next 30 days.
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Scale:</strong> 0.0% (low risk) - 100.0% (high risk)
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Sources:</strong> FIRST API (official) and Grype Scanner
                        </div>
                      </div>
                    </v-tooltip>
                  </div>
                  
                  <div class="metric-value">
                    {{ getEpssDisplayValue() }}
                  </div>
                  
                  <div class="metric-details" v-if="hasEpssData()">
                    <!-- Combined EPSS sources info -->
                    <div class="detail-item combined-sources">
                      <div class="source-part grype-part" v-if="vulnerability?.epss && vulnerability.epss > 0">
                        <v-icon size="14" color="success" class="mr-1">mdi-magnify-scan</v-icon>
                        <span class="detail-text">Scanner: {{ (vulnerability.epss * 100).toFixed(1) }}%</span>
                      </div>
                      <div class="source-separator" v-if="vulnerability?.epss && vulnerability.epss > 0 && vulnerability?.details?.epss_score">|</div>
                      <div class="source-part first-api-part" v-if="vulnerability?.details?.epss_score !== undefined && vulnerability?.details?.epss_score !== null">
                        <v-icon size="14" color="info" class="mr-1">mdi-database</v-icon>
                        <span class="detail-text">FIRST API: {{ (vulnerability.details.epss_score * 100).toFixed(1) }}%</span>
                      </div>
                    </div>
                  </div>
                  

                </div>
              </v-col>

              <!-- CISA KEV Section -->
              <v-col cols="12" md="6" lg="3" class="metric-column">
                <div class="metric-card cisa-metric">
                  <div class="metric-header">
                    <v-icon size="32" :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" class="metric-icon">
                      {{ vulnerability?.details?.cisa_kev_known_exploited ? 'mdi-shield-alert' : 'mdi-shield-check' }}
                    </v-icon>
                    <div class="metric-title">CISA KEV</div>
                    <v-tooltip location="top" max-width="300">
                      <template v-slot:activator="{ props }">
                        <v-icon 
                          v-bind="props" 
                          size="16" 
                          color="grey" 
                          class="ml-2 info-icon"
                        >
                          mdi-information-outline
                        </v-icon>
                      </template>
                      <div class="tooltip-content">
                        <div class="tooltip-title font-weight-bold mb-2">CISA KEV</div>
                        <div class="tooltip-text">
                          <strong>CISA KEV (Known Exploited Vulnerabilities)</strong> - a catalog of vulnerabilities that are actively exploited by attackers.
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Value:</strong> Yes = vulnerability in catalog, No = not in catalog
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Source:</strong> Cybersecurity and Infrastructure Security Agency (CISA)
                        </div>
                      </div>
                    </v-tooltip>
                  </div>
                  
                  <div class="metric-value" :class="vulnerability?.details?.cisa_kev_known_exploited ? 'text-error' : 'text-success'">
                    {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Yes' : 'No' }}
                  </div>
                  
                  <div class="metric-status">
                    <v-chip 
                      :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" 
                      size="small" 
                      variant="outlined"
                      class="status-chip"
                    >
                      {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Known Exploited' : 'Not in KEV' }}
                    </v-chip>
                  </div>
                </div>
              </v-col>

              <!-- Exploit Available Section -->
              <v-col cols="12" md="6" lg="3" class="metric-column">
                <div class="metric-card exploit-metric">
                  <div class="metric-header">
                    <v-icon size="32" :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" class="metric-icon">
                      {{ vulnerability?.details?.exploit_available ? 'mdi-bug' : 'mdi-shield-check' }}
                    </v-icon>
                    <div class="metric-title">Exploit Available</div>
                    <v-tooltip location="top" max-width="300">
                      <template v-slot:activator="{ props }">
                        <v-icon 
                          v-bind="props" 
                          size="16" 
                          color="grey" 
                          class="ml-2 info-icon"
                        >
                          mdi-information-outline
                        </v-icon>
                      </template>
                      <div class="tooltip-content">
                        <div class="tooltip-title font-weight-bold mb-2">Exploit Available</div>
                        <div class="tooltip-text">
                          <strong>Exploit Available</strong> - indicates the presence of a publicly available exploit for this vulnerability.
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Value:</strong> Yes = exploit available, No = exploit not available
                        </div>
                        <div class="tooltip-text mt-2">
                          <strong>Sources:</strong> Exploit-DB, CVE Details and other exploit databases
                        </div>
                      </div>
                    </v-tooltip>
                  </div>
                  
                  <div class="metric-value" :class="vulnerability?.details?.exploit_available ? 'text-error' : 'text-success'">
                    {{ vulnerability?.details?.exploit_available ? 'Yes' : 'No' }}
                  </div>
                  
                  <div class="metric-status">
                    <v-chip 
                      :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" 
                      size="small" 
                      variant="outlined"
                      class="status-chip"
                    >
                      {{ vulnerability?.details?.exploit_available ? 'Available' : 'Not Available' }}
                    </v-chip>
                  </div>
                </div>
              </v-col>
            </v-row>


          </v-card-text>
        </v-card>

        <!-- Main Content -->
        <v-row class="main-content-row">
          <!-- Left Column -->
          <v-col cols="12" lg="8" class="main-content-col">
            <!-- Tabs -->
            <v-card class="mb-6" elevation="2">
              <v-tabs v-model="activeTab" color="primary" grow>
                <v-tab value="details">
                  <v-icon class="mr-2">mdi-information</v-icon>
                  Details
                </v-tab>
                <v-tab value="components">
                  <v-icon class="mr-2">mdi-package-variant</v-icon>
                  Components
                </v-tab>
                <v-tab value="images">
                  <v-icon class="mr-2">mdi-docker</v-icon>
                  Images
                </v-tab>
              </v-tabs>
            </v-card>

            <!-- Tab Content -->
            <v-window v-model="activeTab">
              <!-- Details Tab -->
              <v-window-item value="details">
            <!-- Description Section -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-text</v-icon>
                Description
              </v-card-title>
              <v-card-text>
                <div v-if="vulnerability?.details?.cisa_kev_short_description" class="mb-4">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">CISA KEV Description</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_short_description }}</div>
                </div>
                <div v-if="vulnerability?.details?.cve_details_summary" class="mb-4">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">CVE Details Summary</div>
                  <div class="text-body-1">{{ vulnerability.details.cve_details_summary }}</div>
                </div>
                <div v-if="vulnerability?.description">
                  <div class="text-subtitle-1 font-weight-bold mb-2 text-primary">System Description</div>
                  <div class="text-body-1">{{ vulnerability.description }}</div>
                </div>
                <div v-if="!vulnerability?.details?.cisa_kev_short_description && !vulnerability?.details?.cve_details_summary && !vulnerability?.description" class="text-center py-8">
                  <v-icon size="64" color="grey" class="mb-4">mdi-text-off</v-icon>
                  <div class="text-h6 text-grey">No description available</div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CISA KEV Information -->
            <v-card v-if="vulnerability?.details?.cisa_kev_known_exploited" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="error">mdi-shield-alert</v-icon>
                CISA KEV Information
              </v-card-title>
              <v-card-text>
                <v-row>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Vendor/Project</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_vendor_project || 'N/A' }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Product</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_product || 'N/A' }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Vulnerability Name</div>
                      <div class="text-body-1 font-weight-medium">{{ vulnerability.details.cisa_kev_vulnerability_name || 'N/A' }}</div>
                    </div>
                  </v-col>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Date Added</div>
                      <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability.details.cisa_kev_date_added) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Due Date</div>
                      <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability.details.cisa_kev_due_date) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Ransomware Use</div>
                      <v-chip :color="vulnerability.details.cisa_kev_ransomware_use === 'Known' ? 'error' : 'success'" size="small">
                        {{ vulnerability.details.cisa_kev_ransomware_use || 'Unknown' }}
                      </v-chip>
                    </div>
                  </v-col>
                </v-row>
                <div v-if="vulnerability.details.cisa_kev_required_action" class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Required Action</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_required_action }}</div>
                </div>
                <div v-if="vulnerability.details.cisa_kev_notes" class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Notes</div>
                  <div class="text-body-1">{{ vulnerability.details.cisa_kev_notes }}</div>
                </div>
                <div v-if="vulnerability.details.cisa_kev_cwes?.length">
                  <div class="text-subtitle-2 text-grey mb-1">CWEs</div>
                  <div class="d-flex flex-wrap">
                    <v-chip v-for="cwe in vulnerability.details.cisa_kev_cwes" :key="cwe" size="small" class="mr-2 mb-2" color="warning">
                      {{ cwe }}
                    </v-chip>
                  </div>
                </div>
              </v-card-text>
            </v-card>

            <!-- CVE Details -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-chart-timeline-variant</v-icon>
                CVE Details
              </v-card-title>
              <v-card-text>
                <v-row>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">CVSS Score</div>
                      <div class="d-flex align-center">
                        <v-chip v-if="vulnerability?.details?.cve_details_score" :color="getCvssColor(vulnerability.details.cve_details_score)" size="small" class="mr-2">
                          {{ vulnerability.details.cve_details_score }}
                        </v-chip>
                        <span v-else class="text-grey">N/A</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Severity</div>
                      <v-chip v-if="vulnerability?.details?.cve_details_severity" :color="getSeverityColor(vulnerability.details.cve_details_severity)" size="small">
                        {{ vulnerability.details.cve_details_severity }}
                      </v-chip>
                      <span v-else class="text-grey">N/A</span>
                    </div>
                  </v-col>
                  <v-col cols="12" md="6">
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Published</div>
                      <div class="text-body-1">{{ formatDate(vulnerability?.details?.cve_details_published_date) }}</div>
                    </div>
                    <div class="mb-3">
                      <div class="text-subtitle-2 text-grey mb-1">Updated</div>
                      <div class="text-body-1">{{ formatDate(vulnerability?.details?.cve_details_updated_date) }}</div>
                    </div>
                  </v-col>
                </v-row>
                <div v-if="vulnerability?.details?.cve_details_references?.length">
                  <div class="d-flex align-center justify-space-between mb-2">
                    <div class="text-subtitle-2 text-grey">References</div>
                    <v-btn 
                      variant="text" 
                      size="small" 
                      @click="showReferences = !showReferences"
                      class="text-caption"
                    >
                      <v-icon size="16" class="mr-1">
                        {{ showReferences ? 'mdi-chevron-up' : 'mdi-chevron-down' }}
                      </v-icon>
                      {{ showReferences ? 'Hide' : 'Show' }} ({{ vulnerability.details.cve_details_references.length }})
                    </v-btn>
                  </div>
                  <v-expand-transition>
                    <div v-if="showReferences" class="d-flex flex-column">
                      <a v-for="(ref, index) in vulnerability.details.cve_details_references" :key="index" 
                         :href="ref" target="_blank" class="text-body-2 text-primary mb-1">
                        {{ ref }}
                      </a>
                    </div>
                  </v-expand-transition>
                </div>
              </v-card-text>
            </v-card>

            <!-- Exploit Intelligence -->
            <v-card v-if="vulnerability?.details" class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="error">mdi-shield-alert</v-icon>
                Exploit Intelligence
              </v-card-title>
              <v-card-text>
                <v-row>
                  <!-- General Exploit Status -->
                  <v-col cols="12" md="6">
                    <div class="mb-4">
                      <div class="text-subtitle-1 font-weight-bold mb-2">General Exploit Status</div>
                      <div class="d-flex align-center flex-wrap">
                        <v-chip v-if="vulnerability?.details?.exploit_available" color="error" size="small" class="mr-2 mb-1">
                          <v-icon class="mr-1">mdi-bug</v-icon>
                          Available
                        </v-chip>
                        <v-chip v-if="vulnerability?.details?.exploit_public" color="warning" size="small" class="mr-2 mb-1">
                          Public
                        </v-chip>
                        <v-chip v-if="vulnerability?.details?.exploit_verified" color="success" size="small" class="mb-1">
                          Verified
                        </v-chip>
                        <div v-if="!vulnerability?.details?.exploit_available" class="text-grey text-caption">
                          No general exploit information available
                        </div>
                      </div>
                    </div>
                    
                    <!-- CISA KEV Status -->
                    <div class="mb-4">
                      <div class="text-subtitle-1 font-weight-bold mb-2">CISA KEV Status</div>
                      <div class="d-flex align-center flex-wrap">
                        <v-chip v-if="vulnerability?.details?.cisa_kev_known_exploited" color="error" size="small" class="mr-2 mb-1">
                          <v-icon class="mr-1">mdi-shield-alert</v-icon>
                          Known Exploited
                        </v-chip>
                        <v-chip v-if="vulnerability?.details?.cisa_kev_ransomware_use === 'Known'" color="error" size="small" class="mb-1">
                          <v-icon class="mr-1">mdi-virus</v-icon>
                          Ransomware Use
                        </v-chip>
                        <div v-if="!vulnerability?.details?.cisa_kev_known_exploited" class="text-grey text-caption">
                          Not in CISA KEV
                        </div>
                      </div>
                    </div>
                  </v-col>
                  
                  <!-- Exploit-DB Status -->
                  <v-col cols="12" md="6">
                    <div class="mb-4">
                      <div class="text-subtitle-1 font-weight-bold mb-2">Exploit-DB Status</div>
                      <div v-if="vulnerability?.details?.exploit_db_available">
                        <div class="d-flex align-center flex-wrap mb-2">
                          <v-chip color="orange" size="small" class="mr-2 mb-1">
                            <v-icon class="mr-1">mdi-database</v-icon>
                            Found in Exploit-DB
                          </v-chip>
                          <v-chip v-if="vulnerability?.details?.exploit_db_verified" color="success" size="small" class="mr-2 mb-1">
                            <v-icon class="mr-1">mdi-check-circle</v-icon>
                            Verified
                          </v-chip>
                          <v-chip v-if="vulnerability?.details?.exploit_db_working_count > 0" color="info" size="small" class="mb-1">
                            <v-icon class="mr-1">mdi-cog</v-icon>
                            {{ vulnerability.details.exploit_db_working_count }} Working
                          </v-chip>
                        </div>
                        <div class="text-caption text-grey">
                          Total: {{ vulnerability?.details?.exploit_db_count || 0 }} | 
                          Verified: {{ vulnerability?.details?.exploit_db_verified_count || 0 }} | 
                          Working: {{ vulnerability?.details?.exploit_db_working_count || 0 }}
                        </div>
                      </div>
                      <div v-else class="text-grey text-caption">
                        Not found in Exploit-DB
                      </div>
                    </div>
                  </v-col>
                </v-row>
                
                <!-- Exploit Links Section -->
                <div v-if="vulnerability?.details?.exploit_links?.length || vulnerability?.details?.exploit_db_links?.length" class="mt-4">
                  <div class="text-subtitle-1 font-weight-bold mb-2">Exploit Links</div>
                  <div class="d-flex flex-column">
                    <div v-if="vulnerability?.details?.exploit_links?.length" class="mb-2">
                      <div class="text-caption text-grey mb-1">General Exploit Links:</div>
                      <a v-for="(link, index) in vulnerability.details.exploit_links" :key="`general-${index}`" 
                         :href="link" target="_blank" class="text-body-2 text-primary mb-1 d-block">
                        {{ link }}
                      </a>
                    </div>
                    <div v-if="vulnerability?.details?.exploit_db_links?.length">
                      <div class="text-caption text-grey mb-1">Exploit-DB Links:</div>
                      <a v-for="(link, index) in vulnerability.details.exploit_db_links" :key="`exploitdb-${index}`" 
                         :href="link" target="_blank" class="text-body-2 text-primary mb-1 d-block">
                        {{ link }}
                      </a>
                    </div>
                  </div>
                </div>
              </v-card-text>
            </v-card>
              </v-window-item>

              <!-- Components Tab -->
              <v-window-item value="components">
                <v-card class="mb-6" elevation="2">
                  <v-card-title class="text-h5">
                    <v-icon class="mr-3" color="primary">mdi-package-variant</v-icon>
                    Affected Components
                  </v-card-title>
                  <v-card-text>
                    <div v-if="componentsLoading" class="text-center py-6">
                      <v-progress-circular indeterminate color="primary" size="48"></v-progress-circular>
                      <div class="mt-3 text-body-1">Loading affected components...</div>
                    </div>
                    
                    <div v-else-if="!components || components.length === 0" class="text-center py-6">
                      <v-icon size="48" color="grey" class="mb-3">mdi-package-variant-closed</v-icon>
                      <div class="text-body-1 text-grey mb-1">No affected components found</div>
                      <div class="text-caption text-grey">This vulnerability was not detected in any scanned components.</div>
                    </div>
                    
                    <div v-else>
                      <div class="d-flex justify-space-between align-center mb-3">
                        <div class="text-body-2 text-grey">
                          {{ components.length }} component{{ components.length !== 1 ? 's' : '' }} found
                        </div>
                        <v-btn
                          variant="text"
                          size="small"
                          @click="loadComponents"
                          :loading="componentsLoading"
                          density="compact"
                        >
                          <v-icon size="16" class="mr-1">mdi-refresh</v-icon>
                          Refresh
                        </v-btn>
                      </div>
                      
                      <!-- Components Table -->
                      <v-table class="components-table">
                        <thead>
                          <tr>
                            <th class="text-left">Component</th>
                            <th class="text-left">Type</th>
                            <th class="text-left">Version</th>
                            <th class="text-center">Images</th>
                            <th class="text-center">Vulnerabilities</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="component in components" :key="component.uuid" class="component-row" @click="onComponentRowClick(component)" style="cursor: pointer;">
                            <td class="component-name-cell">
                              <div class="d-flex align-center">
                                <v-avatar size="32" color="grey-darken-3" class="mr-2">
                                  <v-icon color="white" size="16">mdi-package-variant</v-icon>
                                </v-avatar>
                                <span class="font-weight-bold">{{ component.component.name }}</span>
                              </div>
                            </td>
                            <td class="type-cell">
                              <v-chip 
                                size="small" 
                                color="info" 
                                variant="outlined"
                                class="component-type-chip"
                                :title="component.component.type"
                              >
                                <v-icon size="12" class="mr-1">mdi-tag</v-icon>
                                {{ component.component.type }}
                              </v-chip>
                            </td>
                            <td class="version-cell">
                              <div class="version-container">
                                <v-chip 
                                  size="small" 
                                  color="primary" 
                                  variant="outlined"
                                  class="version-chip"
                                  :title="component.version"
                                >
                                  <v-icon size="12" class="mr-1">mdi-pound</v-icon>
                                  {{ component.version }}
                                </v-chip>
                                <div v-if="component.version && component.version.length > 25" class="version-full mt-1">
                                  {{ component.version }}
                                </div>
                              </div>
                            </td>
                            <td class="text-center images-cell">
                              <v-chip 
                                color="success" 
                                size="small" 
                                class="usage-chip"
                                :title="`Used in ${component.used_count} images`"
                                variant="elevated"
                              >
                                <v-icon size="14" class="mr-1">mdi-docker</v-icon>
                                {{ component.used_count }}
                              </v-chip>
                            </td>
                            <td class="text-center vulns-cell">
                              <v-chip 
                                color="warning" 
                                size="small" 
                                class="vulnerabilities-chip"
                                :title="`Has ${component.vulnerabilities_count} vulnerabilities`"
                                variant="elevated"
                              >
                                <v-icon size="14" class="mr-1">mdi-shield-alert</v-icon>
                                {{ component.vulnerabilities_count }}
                              </v-chip>
                            </td>
                          </tr>
                        </tbody>
                      </v-table>
                    </div>
                  </v-card-text>
                </v-card>
              </v-window-item>

              <!-- Images Tab -->
              <v-window-item value="images">
                <v-card class="mb-6" elevation="2">
                  <v-card-title class="text-h5">
                    <v-icon class="mr-3" color="primary">mdi-docker</v-icon>
                    Affected Images
                  </v-card-title>
                  <v-card-text>
                    <div v-if="imagesLoading" class="text-center py-6">
                      <v-progress-circular indeterminate color="primary" size="48"></v-progress-circular>
                      <div class="mt-3 text-body-1">Loading affected images...</div>
                    </div>
                    
                    <div v-else-if="!images || images.length === 0" class="text-center py-6">
                      <v-icon size="48" color="grey" class="mb-3">mdi-docker-off</v-icon>
                      <div class="text-body-1 text-grey mb-1">No affected images found</div>
                      <div class="text-caption text-grey">This vulnerability was not detected in any scanned images.</div>
                    </div>
                    
                    <div v-else>
                      <div class="d-flex justify-space-between align-center mb-3">
                        <div class="text-body-2 text-grey">
                          {{ images.length }} image{{ images.length !== 1 ? 's' : '' }} found
                        </div>
                        <v-btn
                          variant="text"
                          size="small"
                          @click="loadImages"
                          :loading="imagesLoading"
                          density="compact"
                        >
                          <v-icon size="16" class="mr-1">mdi-refresh</v-icon>
                          Refresh
                        </v-btn>
                      </div>
                      
                      <v-list class="pa-0">
                        <v-list-item
                          v-for="image in images"
                          :key="image.uuid"
                          :to="`/images/${image.uuid}`"
                          class="mb-4 pa-4 image-card"
                          style="word-break: break-word; overflow-wrap: break-word;"
                        >
                          <template v-slot:prepend>
                            <v-avatar size="48" color="primary" class="mr-4">
                              <v-icon color="white" size="24">mdi-docker</v-icon>
                            </v-avatar>
                          </template>
                          
                          <v-list-item-title class="font-weight-bold text-truncate mb-2" :title="image.name">
                            {{ image.name }}
                          </v-list-item-title>
                          
                          <v-list-item-subtitle class="pa-0">
                            <!-- Repository and Tag Info -->
                            <div v-if="image.repository_info" class="d-flex align-center flex-wrap mb-3">
                              <v-chip 
                                size="small" 
                                color="info" 
                                variant="outlined"
                                class="mr-2 mb-1 repository-chip"
                                :title="image.repository_info.repository_name"
                              >
                                <v-icon size="14" class="mr-1">mdi-source-repository</v-icon>
                                {{ image.repository_info.repository_name }}
                              </v-chip>
                              <v-chip 
                                size="small" 
                                color="secondary" 
                                variant="outlined"
                                class="mb-1 tag-chip"
                                :title="image.repository_info.tag"
                              >
                                <v-icon size="14" class="mr-1">mdi-tag</v-icon>
                                {{ image.repository_info.tag }}
                              </v-chip>
                            </div>
                            
                            <!-- Status, Digest and Vulnerabilities -->
                            <div class="d-flex flex-column">
                              <div class="d-flex align-center flex-wrap mb-2">
                                <v-chip 
                                  :color="getImageScanStatusColor(image.scan_status)" 
                                  size="small" 
                                  class="mr-3 mb-1 status-chip"
                                >
                                  <v-icon size="14" class="mr-1">
                                    {{ getStatusIcon(image.scan_status) }}
                                  </v-icon>
                                  {{ getShortStatus(image.scan_status) }}
                                </v-chip>
                                <span v-if="image.digest" class="text-caption text-grey digest-text mb-1" :title="image.digest">
                                  {{ image.digest.substring(0, 12) }}...
                                </span>
                              </div>
                              
                              <!-- Vulnerability Count -->
                              <div class="d-flex align-center vulnerability-count">
                                <v-icon size="18" color="error" class="mr-2">mdi-shield-alert</v-icon>
                                <span class="text-body-2 font-weight-bold">
                                  {{ image.findings }} vulns
                                </span>
                              </div>
                            </div>
                          </v-list-item-subtitle>
                          
                          <template v-slot:append>
                            <v-icon size="20" color="grey">mdi-chevron-right</v-icon>
                          </template>
                        </v-list-item>
                      </v-list>
                    </div>
                  </v-card-text>
                </v-card>
              </v-window-item>
            </v-window>
          </v-col>

          <!-- Right Column -->
          <v-col cols="12" lg="4" class="main-content-col">
            <!-- Quick Info -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-information</v-icon>
                Quick Info
              </v-card-title>
              <v-card-text>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Vulnerability Type</div>
                  <div class="text-body-1 font-weight-medium">{{ vulnerability?.vulnerability_type }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Created</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.created_at) }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Last Updated</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.updated_at) }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Data Source</div>
                  <div class="text-body-1 font-weight-medium">{{ vulnerability?.details?.data_source || 'N/A' }}</div>
                </div>
                <div class="mb-4">
                  <div class="text-subtitle-2 text-grey mb-1">Details Updated</div>
                  <div class="text-body-1 font-weight-medium">{{ formatDate(vulnerability?.details?.last_updated) }}</div>
                </div>
              </v-card-text>
            </v-card>

            <!-- Vulnerability Timeline Card -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="info">mdi-timeline-clock</v-icon>
                Vulnerability Timeline
              </v-card-title>
              <v-card-text>
                <div class="timeline-container">
                  <!-- CVE Published -->
                  <div class="timeline-item" v-if="vulnerability?.details?.cve_details_published_date">
                    <div class="timeline-icon published">
                      <v-icon size="16" color="white">mdi-calendar-check</v-icon>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-label">CVE Published</div>
                      <div class="timeline-date">{{ formatDate(vulnerability.details.cve_details_published_date) }}</div>
                    </div>
                  </div>
                  
                  <!-- CVE Updated -->
                  <div class="timeline-item" v-if="vulnerability?.details?.cve_details_updated_date && vulnerability.details.cve_details_updated_date !== vulnerability.details.cve_details_published_date">
                    <div class="timeline-icon updated">
                      <v-icon size="16" color="white">mdi-calendar-edit</v-icon>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-label">CVE Updated</div>
                      <div class="timeline-date">{{ formatDate(vulnerability.details.cve_details_updated_date) }}</div>
                    </div>
                  </div>
                  
                  <!-- CISA KEV Added -->
                  <div class="timeline-item" v-if="vulnerability?.details?.cisa_kev_date_added">
                    <div class="timeline-icon kev">
                      <v-icon size="16" color="white">mdi-shield-alert</v-icon>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-label">Added to CISA KEV</div>
                      <div class="timeline-date">{{ formatDate(vulnerability.details.cisa_kev_date_added) }}</div>
                    </div>
                  </div>
                  
                  <!-- CISA KEV Due Date -->
                  <div class="timeline-item" v-if="vulnerability?.details?.cisa_kev_due_date">
                    <div class="timeline-icon due-date">
                      <v-icon size="16" color="white">mdi-clock-alert</v-icon>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-label">CISA KEV Due Date</div>
                      <div class="timeline-date">{{ formatDate(vulnerability.details.cisa_kev_due_date) }}</div>
                    </div>
                  </div>
                  
                  <!-- No Timeline Data -->
                  <div v-if="!hasTimelineData()" class="text-center py-4">
                    <v-icon size="32" color="grey">mdi-timeline-clock-outline</v-icon>
                    <div class="text-grey text-caption mt-2">No timeline data available</div>
                  </div>
                </div>
              </v-card-text>
            </v-card>

            <!-- Security Status -->
            <v-card class="mb-6" elevation="2">
              <v-card-title class="text-h5">
                <v-icon class="mr-3" color="primary">mdi-shield-check</v-icon>
                Security Status
              </v-card-title>
              <v-card-text>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">CISA KEV</div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_known_exploited ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.cisa_kev_known_exploited ? 'Known Exploited' : 'Not in KEV' }}
                  </v-chip>
                </div>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Exploit Available</div>
                  <v-chip :color="vulnerability?.details?.exploit_available ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.exploit_available ? 'Available' : 'Not Available' }}
                  </v-chip>
                </div>
                <div class="mb-3">
                  <div class="text-subtitle-2 text-grey mb-1">Ransomware Use</div>
                  <v-chip :color="vulnerability?.details?.cisa_kev_ransomware_use === 'Known' ? 'error' : 'success'" size="small">
                    {{ vulnerability?.details?.cisa_kev_ransomware_use || 'Unknown' }}
                  </v-chip>
                </div>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import type { Vulnerability, ComponentVersion } from '@/types/interfaces'
import { notificationService } from '@/plugins/notifications'

const route = useRoute()
const router = useRouter()
const vulnerability = ref<Vulnerability | null>(null)

const goBack = () => {
  // Check if we came from a specific page (stored in sessionStorage)
  const fromPage = sessionStorage.getItem('fromPage')
  if (fromPage) {
    sessionStorage.removeItem('fromPage')
    router.push(fromPage)
  } else {
    // Default fallback to vulnerabilities list
    router.push({ name: 'vulnerabilities' })
  }
}
const loading = ref(true)
const showReferences = ref(false)
const activeTab = ref('details')
const images = ref<any[]>([])
const imagesLoading = ref(false)
const components = ref<ComponentVersion[]>([])
const componentsLoading = ref(false)
const updatingDetails = ref(false)

onMounted(async () => {
  try {
    const vulnerabilityId = route.params.uuid
    if (!vulnerabilityId) {
      console.error('No vulnerability UUID provided')
      return
    }
    
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerabilityId}/`, {
      headers
    })
    
    if (response.ok) {
      vulnerability.value = await response.json()
    } else {
      console.error('Failed to fetch vulnerability:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error fetching vulnerability:', error)
  } finally {
    loading.value = false
  }
})

const getCvssColor = (score: number): string => {
  if (score >= 9.0) return 'error'
  if (score >= 7.0) return 'warning'
  if (score >= 4.0) return 'info'
  return 'success'
}

const getCvssTextColor = (score: number): string => {
  if (score >= 9.0) return 'text-error'
  if (score >= 7.0) return 'text-warning'
  if (score >= 4.0) return 'text-info'
  return 'text-success'
}

const getCvssRange = (score: number): string => {
  if (score >= 9.0) return '9.0 - 10.0 (Critical)'
  if (score >= 7.0) return '7.0 - 8.9 (High)'
  if (score >= 4.0) return '4.0 - 6.9 (Medium)'
  return '0.1 - 3.9 (Low)'
}

const getSeverityColor = (severity?: string): string => {
  if (!severity) return 'grey'
  switch (severity.toUpperCase()) {
    case 'CRITICAL': return 'error'
    case 'HIGH': return 'warning'
    case 'MEDIUM': return 'info'
    case 'LOW': return 'success'
    default: return 'grey'
  }
}

const getSeverityFromScore = (score?: number): string => {
  if (!score) return 'UNKNOWN'
  if (score >= 9.0) return 'CRITICAL'
  if (score >= 7.0) return 'HIGH'
  if (score >= 4.0) return 'MEDIUM'
  return 'LOW'
}

const formatDate = (dateString: string | null | undefined): string => {
  if (!dateString) return 'N/A'
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

const getOverallSecurityColor = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'error'
  if (cvssScore >= 7.0) return 'warning'
  if (cvssScore >= 4.0) return 'info'
  return 'success'
}

const getOverallSecurityStatus = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'Critical'
  if (cvssScore >= 7.0) return 'High Risk'
  if (cvssScore >= 4.0) return 'Medium Risk'
  return 'Low Risk'
}

const getOverallSecurityIcon = (): string => {
  const cvssScore = vulnerability.value?.details?.cve_details_score || 0
  const isKev = vulnerability.value?.details?.cisa_kev_known_exploited || false
  const hasExploit = vulnerability.value?.details?.exploit_available || false
  
  if (cvssScore >= 9.0 || isKev || hasExploit) return 'mdi-alert-circle'
  if (cvssScore >= 7.0) return 'mdi-alert'
  if (cvssScore >= 4.0) return 'mdi-information'
  return 'mdi-check-circle'
}

const getEpssSourceDisplay = (source: string): string => {
  switch (source) {
    case 'FIRST-EPSS':
      return 'FIRST API'
    case 'Grype':
      return 'Grype Scan'
    case 'manual':
      return 'Manual Entry'
    default:
      return source
  }
}

const getEpssValue = (): number | null => {
  // Always prioritize epss_score from FIRST API if available
  if (vulnerability.value?.details?.epss_score) {
    return vulnerability.value.details.epss_score
  }
  // Fallback to base epss from Grype scan
  if (vulnerability.value?.epss && vulnerability.value.epss > 0) {
    return vulnerability.value.epss
  }
  return null
}

const getEpssDisplayValue = (): string => {
  const epssValue = getEpssValue()
  if (epssValue === null) {
    return 'N/A'
  }
  return (epssValue * 100).toFixed(1) + '%'
}

const getEpssDataSource = (): string | null => {
  // Always show FIRST API source if epss_score is available
  if (vulnerability.value?.details?.epss_data_source) {
    return vulnerability.value.details.epss_data_source
  }
  // Fallback to Grype if no FIRST API data
  if (vulnerability.value?.epss && vulnerability.value.epss > 0) {
    return 'Grype'
  }
  return null
}

const hasBothEpssSources = (): boolean => {
  return vulnerability.value?.details?.epss_data_source && vulnerability.value?.epss > 0
}

const hasEpssData = (): boolean => {
  return (vulnerability.value?.epss && vulnerability.value.epss > 0) || 
         (vulnerability.value?.details?.epss_score !== undefined && vulnerability.value?.details?.epss_score !== null)
}

const hasTimelineData = (): boolean => {
  return !!(vulnerability.value?.details?.cve_details_published_date || 
           vulnerability.value?.details?.cve_details_updated_date || 
           vulnerability.value?.details?.cisa_kev_date_added || 
           vulnerability.value?.details?.cisa_kev_due_date)
}

const showGrypeEpssComparison = (): boolean => {
  const firstApiEpss = vulnerability.value?.details?.epss_score || 0
  const grypeEpss = vulnerability.value?.epss || 0
  return firstApiEpss !== grypeEpss && grypeEpss > 0
}

const loadComponents = async () => {
  if (!vulnerability.value) return
  
  componentsLoading.value = true
  try {
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerability.value.uuid}/components/`, {
      headers
    })
    
    if (response.ok) {
      const data = await response.json()
      // Handle both paginated and non-paginated responses
      components.value = data.results || data
    } else {
      console.error('Failed to fetch components:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error fetching components:', error)
  } finally {
    componentsLoading.value = false
  }
}

const loadImages = async () => {
  if (!vulnerability.value) return
  
  imagesLoading.value = true
  try {
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerability.value.uuid}/images/`, {
      headers
    })
    
    if (response.ok) {
      const data = await response.json()
      // Handle both paginated and non-paginated responses
      images.value = data.results || data
    } else {
      console.error('Failed to fetch images:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error fetching images:', error)
  } finally {
    imagesLoading.value = false
  }
}

const getImageScanStatusColor = (status: string): string => {
  switch (status) {
    case 'success': return 'success'
    case 'error': return 'error'
    case 'in_process': return 'warning'
    case 'pending': return 'info'
    default: return 'grey'
  }
}

const getShortStatus = (status: string): string => {
  switch (status) {
    case 'success': return 'OK'
    case 'error': return 'ERR'
    case 'in_process': return 'RUN'
    case 'pending': return 'PND'
    default: return status.substring(0, 3).toUpperCase()
  }
}

const getStatusIcon = (status: string): string => {
  switch (status) {
    case 'success': return 'mdi-check-circle'
    case 'error': return 'mdi-alert-circle'
    case 'in_process': return 'mdi-sync'
    case 'pending': return 'mdi-clock'
    default: return 'mdi-help-circle'
  }
}

const copyToClipboard = async (text: string) => {
  try {
    await navigator.clipboard.writeText(text)
  } catch (err) {
    console.error('Failed to copy to clipboard:', err)
  }
}

const onComponentRowClick = (component: any) => {
  if (component && component.uuid) {
    // Store current page info for back navigation
    const currentRoute = router.currentRoute.value
    const queryString = currentRoute.query ? new URLSearchParams(currentRoute.query as Record<string, string>).toString() : ''
    const fromPage = `${currentRoute.path}${queryString ? '?' + queryString : ''}`
    sessionStorage.setItem('fromPage', fromPage)
    
    router.push({ name: 'component-version', params: { uuid: component.uuid } })
  }
}

const updateVulnerabilityDetails = async () => {
  if (!vulnerability.value) return
  
  updatingDetails.value = true
  try {
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerability.value.uuid}/update_details/`, {
      method: 'POST',
      headers
    })
    
    if (response.ok) {
      const result = await response.json()
      // Show success notification
      notificationService.success(`Vulnerability details update task started. Task ID: ${result.task_id}`)
      // Refresh vulnerability data after a short delay
      setTimeout(() => {
        loadVulnerabilityData()
      }, 2000)
    } else {
      const errorData = await response.json()
      notificationService.error(`Error starting task: ${errorData.message || 'Unknown error'}`)
    }
  } catch (error) {
    console.error('Error updating vulnerability details:', error)
    notificationService.error('Error starting update task')
  } finally {
    updatingDetails.value = false
  }
}

const loadVulnerabilityData = async () => {
  if (!vulnerability.value) return
  
  try {
    const token = localStorage.getItem('token')
    const headers: HeadersInit = {
      'Content-Type': 'application/json'
    }
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch(`/api/vulnerabilities/${vulnerability.value.uuid}/`, {
      headers
    })
    
    if (response.ok) {
      vulnerability.value = await response.json()
    } else {
      console.error('Failed to refresh vulnerability data:', response.status, response.statusText)
    }
  } catch (error) {
    console.error('Error refreshing vulnerability data:', error)
  }
}

// Watch for tab changes to load images when needed
watch(activeTab, (newTab) => {
  if (newTab === 'images' && vulnerability.value && images.value.length === 0) {
    loadImages()
  }
  if (newTab === 'components' && vulnerability.value && components.value.length === 0) {
    loadComponents()
  }
})
</script>

<style scoped>
.vulnerability-detail-container {
  max-width: 100% !important;
  overflow-x: hidden !important;
  min-width: 0 !important;
}

.main-content-row {
  max-width: 100% !important;
  overflow-x: hidden !important;
  min-width: 0 !important;
}

.main-content-col {
  max-width: 100% !important;
  overflow-x: hidden !important;
  min-width: 0 !important;
}

.v-list-item__title {
  font-size: 1.1rem !important;
  line-height: 1.4 !important;
  color: #1a202c !important;
  font-weight: 700 !important;
  word-break: break-word !important;
}

.v-list-item__subtitle {
  font-size: 0.9rem !important;
  line-height: 1.4 !important;
  color: #4a5568 !important;
  word-break: break-word !important;
}
.font-weight-black {
  font-weight: 900;
}
.h-100 {
  height: 100%;
}


.image-card {
  border-radius: 16px !important;
  margin-bottom: 12px !important;
  transition: all 0.3s ease-in-out !important;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
  border: 1px solid rgba(0,0,0,0.06) !important;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
}

.image-card:hover {
  background: linear-gradient(135deg, #ffffff 0%, #f0f2f5 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 25px rgba(0,0,0,0.12) !important;
  border-color: rgba(0,0,0,0.1) !important;
}

.text-truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Enhanced typography */
.v-list-item__title {
  font-size: 1.1rem !important;
  line-height: 1.4 !important;
  color: #1a202c !important;
  font-weight: 700 !important;
}

.v-list-item__subtitle {
  font-size: 0.9rem !important;
  line-height: 1.4 !important;
  color: #4a5568 !important;
}

/* Chip styles */
.repository-chip {
  max-width: 200px !important;
  overflow: hidden !important;
}

.tag-chip {
  max-width: 120px !important;
  overflow: hidden !important;
}

.status-chip {
  min-width: 80px !important;
  font-weight: 600 !important;
}

.digest-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 2px 6px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
}

.vulnerability-count {
  background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%) !important;
  padding: 6px 12px !important;
  border-radius: 20px !important;
  border: 1px solid #fc8181 !important;
}


.image-card {
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.component-card {
  border-radius: 16px !important;
  margin-bottom: 12px !important;
  transition: all 0.3s ease-in-out !important;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
  border: 1px solid rgba(0,0,0,0.06) !important;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
}

.component-card:hover {
  background: linear-gradient(135deg, #ffffff 0%, #f0f2f5 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 25px rgba(0,0,0,0.12) !important;
  border-color: rgba(0,0,0,0.1) !important;
}

.component-type-chip {
  max-width: 200px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
}

.version-chip {
  max-width: 300px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
}

.chip-container {
  min-width: 0 !important;
  width: 100% !important;
}

.usage-vuln-container {
  min-width: 0 !important;
  width: 100% !important;
  gap: 8px !important;
}

/* Table Styles */
.components-table {
  border-radius: 8px !important;
  overflow: hidden !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

.components-table thead th {
  background-color: #f8f9fa !important;
  font-weight: 600 !important;
  font-size: 0.875rem !important;
  color: #374151 !important;
  padding: 12px 16px !important;
  border-bottom: 2px solid #e5e7eb !important;
}

.components-table tbody td {
  padding: 12px 16px !important;
  border-bottom: 1px solid #f3f4f6 !important;
  vertical-align: middle !important;
}

.component-row:hover {
  background-color: #f9fafb !important;
  transform: translateX(4px);
  transition: all 0.2s ease;
}

.component-name-cell {
  min-width: 200px !important;
  max-width: 300px !important;
}

.type-cell {
  min-width: 120px !important;
  max-width: 150px !important;
}

.version-cell {
  min-width: 150px !important;
  max-width: 250px !important;
}

.images-cell,
.vulns-cell {
  min-width: 80px !important;
  max-width: 100px !important;
}



.version-container {
  display: flex !important;
  flex-direction: column !important;
  gap: 4px !important;
}

.version-full {
  word-break: break-all !important;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 6px 10px !important;
  border-radius: 6px !important;
  border: 1px solid #e2e8f0 !important;
  margin-top: 6px !important;
  font-size: 0.8rem !important;
  line-height: 1.3 !important;
  color: #2d3748 !important;
  font-weight: 500 !important;
}

.usage-chip {
  min-width: 100px !important;
  font-weight: 600 !important;
  font-size: 0.8rem !important;
  height: 28px !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.vulnerabilities-chip {
  min-width: 100px !important;
  font-weight: 600 !important;
  font-size: 0.8rem !important;
  height: 28px !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.purl-container {
  max-width: 100% !important;
  overflow: hidden !important;
}

.purl-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 4px 8px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
  word-break: break-all !important;
  display: block !important;
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
}

.copy-btn {
  min-width: 24px !important;
  height: 24px !important;
  padding: 0 !important;
}

.cpe-container {
  max-width: 100% !important;
  overflow: hidden !important;
}

.cpe-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 4px 8px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
  word-break: break-all !important;
  display: block !important;
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
}

.repository-chip {
  max-width: 200px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

.tag-chip {
  max-width: 120px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

.status-chip {
  min-width: 80px !important;
  font-weight: 600 !important;
}

.digest-text {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  background-color: #f7fafc !important;
  padding: 2px 6px !important;
  border-radius: 4px !important;
  border: 1px solid #e2e8f0 !important;
  max-width: 150px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

.vulnerability-count {
  background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%) !important;
  padding: 6px 12px !important;
  border-radius: 20px !important;
  border: 1px solid #fc8181 !important;
  flex-shrink: 0 !important;
}

.update-details-btn {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
  border-radius: 50% !important;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.6) 0%, rgba(118, 75, 162, 0.6) 100%) !important;
  border: none !important;
  position: relative !important;
  overflow: hidden !important;
  opacity: 0.7 !important;
  backdrop-filter: blur(10px) !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.update-details-btn::before {
  content: '' !important;
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: linear-gradient(135deg, rgba(118, 75, 162, 0.8) 0%, rgba(102, 126, 234, 0.8) 100%) !important;
  opacity: 0 !important;
  transition: opacity 0.3s ease !important;
  border-radius: 50% !important;
}

.update-details-btn:hover {
  transform: translateY(-2px) scale(1.1) !important;
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3) !important;
  opacity: 1 !important;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%) !important;
}

.update-details-btn:active {
  transform: translateY(0) scale(0.95) !important;
  box-shadow: 0 3px 12px rgba(102, 126, 234, 0.2) !important;
}

.update-details-btn .update-icon {
  transition: transform 0.3s ease !important;
  position: relative !important;
  z-index: 1 !important;
  color: rgba(255, 255, 255, 0.9) !important;
}

.update-details-btn:hover .update-icon {
  transform: rotate(180deg) !important;
  color: rgba(255, 255, 255, 1) !important;
}

.update-details-btn:active .update-icon {
  transform: rotate(180deg) scale(0.9) !important;
}

/* Loading state styles */
.update-details-btn.v-btn--loading {
  background: linear-gradient(135deg, rgba(156, 163, 175, 0.6) 0%, rgba(107, 114, 128, 0.6) 100%) !important;
  transform: scale(0.95) !important;
  opacity: 0.8 !important;
}

/* Tooltip styles */
.tooltip-text {
  font-size: 0.875rem !important;
  font-weight: 500 !important;
  color: #ffffff !important;
  background: rgba(0, 0, 0, 0.9) !important;
  padding: 8px 12px !important;
  border-radius: 6px !important;
  max-width: 200px !important;
  text-align: center !important;
}

/* Status indicator styles */
.status-indicator {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
  border-radius: 8px !important;
  padding: 8px 12px !important;
  border: 1px solid rgba(0, 0, 0, 0.06) !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
}

/* New styles for EPSS tooltip */
.epss-tooltip-content {
  font-size: 0.875rem !important;
  line-height: 1.4 !important;
  color: #4a5568 !important;
  padding: 8px 12px !important;
  border-radius: 6px !important;
  max-width: 250px !important;
  text-align: left !important;
  background: rgba(0, 0, 0, 0.9) !important;
  color: #ffffff !important;
}

.epss-tooltip-content .text-subtitle-2 {
  font-weight: 600 !important;
  color: #ffffff !important;
  margin-bottom: 8px !important;
}

.epss-tooltip-content .mb-1 {
  margin-bottom: 4px !important;
}

.epss-tooltip-content strong {
  font-weight: 700 !important;
  color: #ffffff !important;
}

.epss-tooltip-content .text-caption {
  font-size: 0.75rem !important;
  color: #a0aec0 !important;
}

.cursor-pointer {
  cursor: pointer !important;
}

/* EPSS Card Alignment Styles */
.epss-card {
  min-height: 200px !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
}

.epss-content {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: flex-start !important;
  min-height: 120px !important;
}

.epss-details {
  margin-top: 8px !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  gap: 2px !important;
}

.grype-comparison {
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
}

.source-info {
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
}

.epss-meta {
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
  opacity: 0.8 !important;
}

/* Individual card content styles */
.cvss-content,
.cisa-content,
.exploit-content {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  min-height: 120px !important;
}

/* Card-specific styles */
.cvss-card,
.cisa-card,
.exploit-card {
  min-height: 200px !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
}

/* Ensure all metric cards have consistent height and alignment */
.v-col .text-center {
  min-height: 200px !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
}

.v-col .text-center .d-flex.align-center.justify-center {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
}

/* Consistent spacing for all metric cards */
.v-col .text-center .mb-3 {
  margin-bottom: 16px !important;
}

.v-col .text-center .text-h4 {
  margin-bottom: 4px !important;
  line-height: 1.2 !important;
}

.v-col .text-center .text-caption {
  margin-bottom: 8px !important;
  line-height: 1.2 !important;
}

/* Chip and progress bar alignment */
.v-col .text-center .v-chip,
.v-col .text-center .v-progress-linear {
  margin-top: auto !important;
}

@media (max-width: 768px) {
  .update-details-btn {
    transform: scale(0.8) !important;
    margin-left: 8px !important;
  }
  .update-details-btn:hover {
    transform: translateY(-1px) scale(0.9) !important;
  }
  .update-details-btn:active {
    transform: translateY(0) scale(0.75) !important;
  }
  /* Adjust header layout for mobile */
  .d-flex.align-center.mb-2 {
    flex-direction: column !important;
    align-items: flex-start !important;
  }
  .d-flex.align-center.mb-2 h1 {
    margin-bottom: 8px !important;
  }
  
  /* Mobile metric cards */
  .epss-card,
  .cvss-card,
  .cisa-card,
  .exploit-card {
    min-height: 160px !important;
    margin-bottom: 16px !important;
  }
  
  .epss-content,
  .cvss-content,
  .cisa-content,
  .exploit-content {
    min-height: 80px !important;
  }
  
  .epss-details {
    margin-top: 4px !important;
    gap: 1px !important;
  }
  
  .text-h4 {
    font-size: 1.5rem !important;
  }
  
  .grype-comparison,
  .source-info,
  .epss-meta {
    font-size: 0.7rem !important;
  }
}

@media (max-width: 480px) {
  .update-details-btn {
    transform: scale(0.7) !important;
    margin-left: 4px !important;
  }
  
  .update-details-btn:hover {
    transform: translateY(-1px) scale(0.8) !important;
  }
  
  .update-details-btn:active {
    transform: translateY(0) scale(0.65) !important;
  }
}

/* Security Metrics Card - Modern Design */
.security-metrics-card {
  border-radius: 16px !important;
  border: 1px solid rgba(0, 0, 0, 0.08) !important;
  background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%) !important;
}

.security-metrics-card .v-card-title {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
  border-bottom: 1px solid rgba(0, 0, 0, 0.06) !important;
  border-radius: 16px 16px 0 0 !important;
}

/* Metrics Grid */
.metrics-grid {
  margin: 0 !important;
}

.metric-column {
  padding: 12px !important;
}

/* Individual Metric Cards */
.metric-card {
  background: #ffffff !important;
  border: 1px solid rgba(0, 0, 0, 0.06) !important;
  border-radius: 12px !important;
  padding: 24px 20px !important;
  height: 180px !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
  position: relative !important;
  overflow: hidden !important;
}

.metric-card::before {
  content: '' !important;
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  height: 3px !important;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4) !important;
  opacity: 0 !important;
  transition: opacity 0.3s ease !important;
}

.metric-card:hover::before {
  opacity: 1 !important;
}

.metric-card:hover {
  transform: translateY(-4px) !important;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12) !important;
  border-color: rgba(59, 130, 246, 0.2) !important;
}

/* Metric Header */
.metric-header {
  display: flex !important;
  align-items: center !important;
  margin-bottom: 16px !important;
}

/* Info Icon */
.info-icon {
  opacity: 0.6 !important;
  transition: opacity 0.2s ease !important;
  cursor: help !important;
}

.info-icon:hover {
  opacity: 0.8 !important;
}

.metric-icon {
  margin-right: 12px !important;
  background: rgba(59, 130, 246, 0.1) !important;
  padding: 8px !important;
  border-radius: 10px !important;
}

.metric-title {
  font-size: 0.875rem !important;
  font-weight: 600 !important;
  color: #64748b !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
}

/* Metric Value */
.metric-value {
  font-size: 2.4rem !important;
  font-weight: 800 !important;
  color: #1e293b !important;
  line-height: 1 !important;
  margin-bottom: 16px !important;
  text-align: center !important;
}

/* Metric Details (for EPSS) */
.metric-details {
  display: flex !important;
  flex-direction: row !important;
  gap: 8px !important;
  margin-bottom: 16px !important;
  align-items: center !important;
  justify-content: center !important;
  flex-wrap: wrap !important;
}

/* Combined sources styling */
.combined-sources {
  display: flex !important;
  align-items: center !important;
  background: rgba(0, 0, 0, 0.04) !important;
  border-radius: 8px !important;
  padding: 8px 12px !important;
  gap: 12px !important;
}

/* Tooltip styling */
.tooltip-content {
  padding: 8px !important;
}

/* Timeline styling */
.timeline-container {
  padding: 8px 0 !important;
}

.timeline-item {
  display: flex !important;
  align-items: flex-start !important;
  margin-bottom: 16px !important;
  position: relative !important;
}

.timeline-item:last-child {
  margin-bottom: 0 !important;
}

.timeline-icon {
  width: 32px !important;
  height: 32px !important;
  border-radius: 50% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  margin-right: 12px !important;
  flex-shrink: 0 !important;
}

.timeline-icon.published {
  background: #10b981 !important;
}

.timeline-icon.updated {
  background: #3b82f6 !important;
}

.timeline-icon.kev {
  background: #ef4444 !important;
}

.timeline-icon.due-date {
  background: #f59e0b !important;
}

.timeline-content {
  flex: 1 !important;
  min-width: 0 !important;
}

.timeline-label {
  font-size: 0.75rem !important;
  font-weight: 600 !important;
  color: #374151 !important;
  margin-bottom: 2px !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
}

.timeline-date {
  font-size: 0.875rem !important;
  color: #6b7280 !important;
  font-weight: 500 !important;
}

.tooltip-title {
  color: #1e293b !important;
  font-size: 0.875rem !important;
}

.tooltip-text {
  color: #64748b !important;
  font-size: 0.75rem !important;
  line-height: 1.4 !important;
}

.source-part {
  display: flex !important;
  align-items: center !important;
}

.source-separator {
  color: #94a3b8 !important;
  font-weight: 500 !important;
  font-size: 0.8rem !important;
}

.detail-item {
  display: flex !important;
  align-items: center !important;
  font-size: 0.75rem !important;
  color: #64748b !important;
  padding: 4px 8px !important;
  border-radius: 6px !important;
  background: rgba(0, 0, 0, 0.02) !important;
  transition: all 0.2s ease !important;
}

.detail-item:hover {
  background: rgba(0, 0, 0, 0.04) !important;
}

.detail-text {
  font-weight: 500 !important;
}

.separator {
  margin: 0 4px !important;
  color: #94a3b8 !important;
}

/* Metric Progress */
.metric-progress {
  margin-top: auto !important;
}

.progress-bar {
  border-radius: 3px !important;
}

/* Metric Status */
.metric-status {
  margin-top: auto !important;
  text-align: center !important;
}

.status-chip {
  font-weight: 600 !important;
  border-width: 2px !important;
}

/* Overall Status */
.overall-status {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 16px 0 !important;
}

.status-label {
  font-size: 1rem !important;
  font-weight: 600 !important;
  color: #475569 !important;
}

.status-indicator {
  display: flex !important;
  align-items: center !important;
}

/* Specific Metric Styles */
.cvss-metric .metric-icon {
  background: rgba(59, 130, 246, 0.1) !important;
  color: #3b82f6 !important;
}



.epss-metric .metric-icon {
  background: rgba(6, 182, 212, 0.1) !important;
  color: #06b6d4 !important;
}

.cisa-metric .metric-icon {
  background: rgba(34, 197, 94, 0.1) !important;
}

.exploit-metric .metric-icon {
  background: rgba(34, 197, 94, 0.1) !important;
}

/* Hover Effects */
.metric-card:hover .metric-icon {
  transform: scale(1.1) !important;
  transition: transform 0.3s ease !important;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .metric-card {
    height: 180px !important;
    padding: 20px 16px !important;
  }
  
  .metric-value {
    font-size: 2rem !important;
  }
  
  .metric-details {
    gap: 4px !important;
  }
  
  .detail-item {
    font-size: 0.7rem !important;
    padding: 3px 6px !important;
  }
  
  .overall-status {
    flex-direction: column !important;
    gap: 12px !important;
    align-items: flex-start !important;
  }
}

@media (max-width: 480px) {
  .metric-column {
    padding: 8px !important;
  }
  
  .metric-card {
    height: 160px !important;
    padding: 16px 12px !important;
  }
  
  .metric-value {
    font-size: 1.75rem !important;
  }
}
</style> 