<template>
  <v-container class="py-6">
    <v-row>
      <v-col cols="12">
        <v-btn variant="text" @click="router.back()" class="mb-2">
          ‚Üê Back
        </v-btn>
        <div class="d-flex align-center mb-2">
          <h1 class="text-h4 font-weight-black mr-4">
            {{ vulnerability?.vulnerability_id || 'Vulnerability Detail' }}
          </h1>
          <v-chip :color="getSeverityColor(vulnerability?.severity)" size="large">
            {{ vulnerability?.severity || 'Unknown' }}
          </v-chip>
        </div>
        <v-tabs v-model="activeTab" color="primary" grow class="mb-2">
          <v-tab value="overview">Overview</v-tab>
          <v-tab value="instances">Instances</v-tab>
          <v-tab value="activity">Activity</v-tab>
        </v-tabs>
      </v-col>
    </v-row>
    <v-window v-model="activeTab">
      <v-window-item value="overview">
        <v-row class="mb-2" dense>
          <v-col cols="12" md="3">
            <v-card class="pa-3">
              <div class="font-weight-bold mb-1">Predicates</div>
              <div class="mb-1">KEV: <v-chip color="success" size="small">No</v-chip></div>
              <div>Ransomware use: <v-chip color="success" size="small">No</v-chip></div>
            </v-card>
          </v-col>
          <v-col cols="12" md="3">
            <v-card class="pa-3">
              <div class="font-weight-bold mb-1">EPSS</div>
              <div>Score: <v-chip color="info" size="small">{{ vulnerability?.epss !== undefined ? (vulnerability.epss * 100).toFixed(2) + '%' : 'N/A' }}</v-chip></div>
              <div>Percentile: <v-chip color="primary" size="small">1st</v-chip></div>
            </v-card>
          </v-col>
          <v-col cols="12" md="3">
            <v-card class="pa-3">
              <div class="font-weight-bold mb-1">CVSS</div>
              <div>Base Score: <v-chip color="error" size="small">7.8</v-chip></div>
              <div>Vector: <span class="text-caption">AV:L/AC:H/PR:L/UI:N/S:C/C:H/I:H/A:H</span></div>
            </v-card>
          </v-col>
          <v-col cols="12" md="3">
            <v-card class="pa-3">
              <div class="font-weight-bold mb-1">Reachability</div>
              <div><v-chip color="warning" size="small">Exported</v-chip></div>
              <div class="text-caption">Reachable from an exported function</div>
            </v-card>
          </v-col>
        </v-row>
        <v-row class="mb-2" dense>
          <v-col cols="12" md="6">
            <v-card class="pa-3">
              <div class="font-weight-bold mb-1">Confidence</div>
              <div><v-chip color="success" size="small">100%</v-chip></div>
              <div class="text-caption">Manual validation is required when the confidence level is below 60%.</div>
            </v-card>
          </v-col>
          <v-col cols="12" md="6">
            <v-card class="pa-3">
              <div class="font-weight-bold mb-1">SSVC</div>
              <div>Automatable: <v-chip color="grey" size="small">False</v-chip></div>
              <div>Exploitation: <v-chip color="grey" size="small">None</v-chip></div>
              <div>Technical Impact: <v-chip color="primary" size="small">Total</v-chip></div>
            </v-card>
          </v-col>
        </v-row>
        <v-row class="mb-2" dense>
          <v-col cols="12" md="6">
            <v-card class="pa-4 h-100">
              <div class="font-weight-bold mb-2">Description</div>
              <div>{{ vulnerability?.description || 'No description available.' }}</div>
            </v-card>
          </v-col>
          <v-col cols="12" md="6">
            <v-card class="pa-4 h-100">
              <div class="font-weight-bold mb-2">Impact</div>
              <div>
                This vulnerability can be used by threat actors to bypass security mechanisms provided by UEFI firmware such as Secure Boot and install their malicious components such as UEFI bootkits.
              </div>
            </v-card>
          </v-col>
        </v-row>
        <v-row class="mb-2" dense>
          <v-col cols="12" md="6">
            <v-card class="pa-4 h-100">
              <div class="font-weight-bold mb-2">Recommended Action</div>
              <div>Verify affected firmware versions have been patched. Keep firmware and BIOS up to date.</div>
            </v-card>
          </v-col>
          <v-col cols="12" md="6">
            <v-card class="pa-4 h-100">
              <div class="font-weight-bold mb-2">References</div>
              <ul class="pl-2">
                <li><a href="#" target="_blank">Hydrophobia (CVE-2025-4275)</a></li>
                <li><a href="#" target="_blank">https://www.kb.cert.org/vuls/id/213141</a></li>
                <li><a href="#" target="_blank">https://www.insyde.com/security-pledge/sa-2025002</a></li>
                <li><a href="#" target="_blank">https://www.insyde.com/security-pledge/sa-2025007</a></li>
                <li><a href="#" target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2025-4275</a></li>
              </ul>
            </v-card>
          </v-col>
        </v-row>
      </v-window-item>
      <v-window-item value="instances">
        <v-card class="pa-4 mt-4">
          <v-card-title>Instances</v-card-title>
          <v-card-text class="text-grey">(Not implemented yet)</v-card-text>
        </v-card>
      </v-window-item>
      <v-window-item value="activity">
        <v-card class="pa-4 mt-4">
          <v-card-title>Activity</v-card-title>
          <v-card-text class="text-grey">(Not implemented yet)</v-card-text>
        </v-card>
      </v-window-item>
    </v-window>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import api from '../plugins/axios'
import type { Vulnerability } from '../types/interfaces'

const route = useRoute()
const router = useRouter()
const vulnerability = ref<Vulnerability | null>(null)
const activeTab = ref('overview')

const getSeverityColor = (severity?: string) => {
  if (!severity) return 'grey'
  const map: Record<string, string> = {
    'CRITICAL': 'error',
    'HIGH': 'warning',
    'MEDIUM': 'orange',
    'LOW': 'info',
    'UNKNOWN': 'grey',
    'NEGLIGIBLE': 'grey'
  }
  return map[severity.toUpperCase()] || 'grey'
}

const fetchVulnerability = async () => {
  const uuid = route.params.uuid
  if (!uuid) return
  try {
    const resp = await api.get(`/vulnerabilities/${uuid}/`)
    vulnerability.value = resp.data
  } catch (e) {
    vulnerability.value = null
  }
}

onMounted(fetchVulnerability)
</script>

<style scoped>
.font-weight-black {
  font-weight: 900;
}
.h-100 {
  height: 100%;
}
</style> 